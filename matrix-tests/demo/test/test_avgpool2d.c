#include "../../isa/utils.h"
#include "../ops/pool2d.h"
#include "../ops/tensor.h"
#include <riscv_matrix.h>

static void test_avgpool2d3() {
  float src[] = {1.8042,  0.1353,  0.3102, -0.7233,  0.2986, -0.1328,  1.5550, -0.6523,
        -0.8803, -0.5182,  2.5823,  0.1618,  0.5002, -0.2535,  0.0952,  0.5019,
        -1.5218,  0.8423,  0.7166,  0.8793,  1.9332,  0.4836, -1.0595,  0.8032,
        -0.9378, -0.5307, -1.1050, -0.9142, -0.1352,  0.2554,  0.8120,  2.6700,
         1.7417,  1.3798, -0.0171, -0.0458, -0.8309, -0.1183,  0.0875,  1.2618,
         1.3443, -1.1814,  0.0828,  1.1116, -0.5861,  1.7887,  2.6874, -1.2642,
        -2.0525,  0.5712, -0.7381, -0.7233,  0.6936,  0.8954,  2.5942,  0.2051,
        -0.0237, -0.6884, -1.7357,  1.5317, -0.2520,  0.0933,  0.4579, -0.1948,
        -0.8191,  0.1227, -1.3690, -1.6417, -0.7973, -0.7671, -0.2775, -0.1231,
        -0.5380, -1.0397, -0.1908, -0.6744,  0.1771, -1.0362,  2.3630, -1.6759,
         0.9130,  0.8896,  0.2409,  0.4613,  1.4928, -0.2175, -0.8353,  0.2741,
         0.3119, -1.2825, -1.3644,  0.0616,  1.0888,  0.6583, -1.1340,  0.6047,
         0.3865, -0.2852, -2.9886,  0.1343,  0.7735,  0.7423, -0.3946, -0.6090,
         0.6775, -0.1526,  0.6693,  0.6628,  2.4286,  0.6133, -1.0814,  0.0502,
        -1.0434,  0.7824, -0.7779,  1.4577,  0.2500, -1.1456, -1.7011,  0.8499,
         1.1860, -0.3485,  2.7184,  2.0429, -1.1918,  0.6900, -0.0721,  0.1202,
         0.0116, -0.3029,  0.0735, -1.2605,  1.0612, -0.4466,  1.0268, -2.5869,
         1.4690,  1.0746, -0.5428, -1.0970, -0.2113, -1.4424, -0.2237, -1.0418,
        -0.0731, -2.3314,  0.9507,  0.2613,  0.9086,  0.0183, -0.5665,  0.4414,
         0.9201, -0.1046,  0.4551,  0.5454,  0.1066, -1.0497,  2.2771, -0.2822,
         0.3042, -0.6539,  0.2706,  1.1832,  0.1067,  0.0964,  0.5278,  0.6255,
        -0.2491,  1.3965,  0.0141,  0.7879,  0.8770,  0.6971,  0.6249, -2.3609,
        -0.4024, -1.1665,  0.3388, -1.5441, -0.3272,  2.0298,  1.4971, -0.4535,
         1.8318, -0.0191,  0.4074,  0.3027,  1.3274,  1.0022, -0.7336, -1.0168,
        -0.6871,  0.6456,  2.0928,  1.3100, -0.8065,  1.8504,  0.0948,  0.7321,
        -0.0492, -0.8343, -1.1139, -2.2716, -0.2933, -0.7304, -0.3813, -0.2625,
        -2.2032,  0.7779,  1.6968,  0.9067, -2.4580, -0.7858, -0.1120,  1.3319,
        -1.0422, -0.8309,  0.8812, -0.2428,  0.4341,  1.6183,  0.3761, -0.3017,
        -0.0728,  0.3022,  0.4421,  0.4818, -0.5668,  1.4627,  0.6469, -0.1068,
         0.1292,  0.2879,  0.7609,  1.6033,  0.4278, -0.9367, -0.2430, -0.7060,
         0.0398, -0.6426, -1.0918,  0.6029,  1.4574};
  float ans[] = {0.4564,  0.2169, -0.1547, -0.0579,  0.0468,  0.4280,  0.0244, -0.0415,
         0.0624,  0.1837,  0.3838,  0.1082, -0.0611,  0.1500,  0.0644,  0.3391,
         0.0347, -0.0071, -0.2196,  0.2113,  0.1157, -0.0713,  0.0072, -0.1060,
         0.0697,  0.1440,  0.1212, -0.1060, -0.2262, -0.0673,  0.4704,  0.2775,
        -0.2501,  0.0365,  0.0896,  0.5161,  0.0632,  0.0330,  0.2844,  0.1521,
         0.5246,  0.1006, -0.0205,  0.2210, -0.0246,  0.5521, -0.0548,  0.1650,
        -0.2254,  0.2352,  0.0758, -0.0845,  0.3181, -0.0394, -0.0281,  0.0301,
         0.1298,  0.0350, -0.2873, -0.0906,  0.0102,  0.1586, -0.2001,  0.1377,
         0.1224,  0.0587,  0.0461, -0.0353,  0.4832,  0.1123,  0.0913,  0.1110,
         0.0277,  0.4633,  0.0242,  0.2954,  0.0954,  0.2524, -0.1020,  0.3217,
        -0.0339, -0.0694,  0.3251,  0.0321,  0.0760, -0.0824,  0.0431,  0.1604,
        -0.3134,  0.0861, -0.3520,  0.2436, -0.0793,  0.2668,  0.1251, -0.3032,
         0.1127, -0.0008,  0.5967,  0.0836, -0.0568,  0.1020,  0.2864,  0.6756,
         0.1209,  0.2644, -0.1723,  0.3245,  0.0783,  0.3002, -0.0052, -0.1330,
         0.3855, -0.0868,  0.1241, -0.0540, -0.0021,  0.3070, -0.4166,  0.1656,
        -0.1331,  0.2773, -0.1780,  0.1424,  0.1218, -0.0519,  0.2263, -0.0865,
         0.4173,  0.2518,  0.1968,  0.1406,  0.2607,  0.4572,  0.4026,  0.4551,
        -0.0549,  0.2452,  0.1241,  0.4398,  0.1695, -0.1476,  0.2542,  0.0825,
         0.4103,  0.0882, -0.0966,  0.1627, -0.1924,  0.2803, -0.1471,  0.2167,
        -0.0826,  0.0480,  0.0789, -0.1400,  0.1874, -0.1611,  0.1953,  0.2835,
         0.0561,  0.1481,  0.2201,  0.3862,  0.4916,  0.2421,  0.0346,  0.0730,
         0.1299,  0.4159,  0.2093, -0.1344, -0.0567,  0.0159,  0.5082,  0.2022,
        -0.1051,  0.0217, -0.1313,  0.3036};
  const int B = 1;
  const int C = 5;
  const int H = 7;
  const int W = 7;
  float dst[5 * 6 * 6];
  create_conv2d_default_config(cfg, 1, 1, 1, 4);
  create_tensor4d(avgpool_src, (void *)src, B, H, W, C);
  create_tensor4d(avgpool_dst, (void *)dst, B, 6, 6, C);
  create_tensor4d(avgpool_ans, (void *)ans, B, 6, 6, C);
  avgpool2d(&avgpool_dst, &avgpool_src, &cfg);
  float *dst_ptr = (float *)avgpool_dst.data;
  float *ans_ptr = (float *)avgpool_ans.data;
  EXCEPT_FP32_ARRAY_LAX_EQ(ans_ptr, dst_ptr, 6 * 6 * C, "AVGPOOL2D [1, 7, 7, 5]");
}

int main() {
  test_avgpool2d3();
  return 0;
}
