#include "../../isa/utils.h"
#include "../ops/matmul.h"
#include "../ops/tensor.h"
#include <riscv_matrix.h>

static void test_matmul1() {
  float src1[] = {
      0.37365478,  0.65990734,  0.55949396,  0.2823681,   0.1191001,
      0.66203374,  0.4169063,   -0.85677403, -0.7334652,  -0.04222292,
      0.1217971,   0.57035583,  0.5302108,   -0.45599297, -0.0432009,
      0.37374198,  0.2067353,   -0.07734592, 0.15994725,  -0.4924601,
      -0.9547368,  0.48767036,  0.80004764,  0.27568766,  -0.9925781,
      -0.5863289,  -0.84641886, 0.6703844,   0.35881007,  0.22526683,
      0.92858285,  -0.81832045, -0.64859945, -0.35227266, -0.6590924,
      0.32063553,  -0.1490265,  0.28405017,  -0.5544037,  0.40051454,
      0.6090652,   -0.7874659,  0.84669256,  -0.65355396, 0.79795545,
      -0.3723843,  0.39717087,  -0.60422105, -0.08427878, 0.03336071,
      0.01872376,  -0.9399491,  0.1543718,   -0.6476563,  0.20847923,
      0.0937652,   -0.19633096, -0.775482,   0.0965432,   -0.34454343,
      -0.42522225, 0.590659,    -0.653757,   0.4256903,   0.23450424,
      0.2145274,   -0.09097724, 0.6417308,   -0.81795865, -0.7794875,
      -0.09080823, -0.27413896, -0.12131134, -0.2968787,  0.90633494,
      0.05123657,  0.89109045,  -0.4385435,  -0.0618772,  0.58521295,
      0.26216182,  0.7529008,   0.86877644,  0.02400414,  -0.94471425,
      -0.07629287, 0.46834698,  0.2790712,   -0.15001588, -0.25107107};
  float src2[] = {
      0.7558017,   0.5413845,   0.9960696,   -0.02864381, 0.12878236,
      0.66511136,  0.5162097,   0.14256765,  -0.02471743, 0.064087,
      -0.4220342,  0.5427051,   0.7400626,   -0.5732827,  -0.05123392,
      -0.1499836,  0.54249674,  0.7054955,   0.42744884,  0.711437,
      -0.7295093,  0.26890412,  -0.06273954, -0.26287055, -0.87355757,
      0.6662345,   0.36733043,  -0.18381192, 0.71235627,  -0.6091448,
      0.286146,    0.23017079,  -0.95781684, 0.09928544,  0.29048675,
      -0.46373025, -0.4096313,  -0.14702015, -0.7711092,  -0.57277673,
      -0.98384213, -0.6387873,  -0.76343423, 0.2277978,   -0.13512222,
      -0.8100906,  -0.22660732, -0.9906913,  -0.45195568, -0.4065321,
      -0.49415147, 0.0022965,   -0.38247994, 0.21252668,  0.70524734,
      0.7263249,   0.25291866,  0.38153273,  0.09036846,  0.737392,
      0.85230505,  0.7174703,   -0.82453835, -0.6943921,  -0.12009632,
      0.9443854,   0.11198699,  0.22470048,  0.9976086,   -0.0233323,
      0.7126991,   0.8920996,   -0.21314208, 0.47620758,  -0.08214538,
      0.41321513,  -0.475023,   -0.9710911,  -0.00867448, -0.19152142,
      0.83342963,  0.54363436,  -0.11167506, -0.19022188, -0.19492151,
      0.4653623,   0.55074316,  0.48048815,  -0.21261373, 0.29931134};
  float dist[] = {
      -0.5157304,  -0.38564909, 0.01796139,  0.6405722,   -0.0762016,
      0.80454326,  -0.43549532, -0.76069766, 0.32141218,  -0.00680803,
      0.50311273,  -0.16492476, 0.9137604,   0.86392224,  0.43534136,
      0.3787389,   -0.9433517,  -0.22469327, 0.29048315,  -0.97009045,
      -0.09203754, 0.2781459,   -0.12419473, -0.23620842, -0.9212025,
      -0.48586372, -0.5647876,  0.45333347,  -0.8937913,  -0.6983414,
      -0.37403306, 0.34423092,  0.9724032,   0.10167661,  0.7443325,
      -0.32113588, -0.3235797,  -0.98199165, -0.24130332, 0.3981605,
      0.38788253,  -0.9393629,  -0.40702692, 0.06798239,  0.73551595,
      -0.44501272, -0.3161103,  -0.47168484, -0.92142856, 0.793155,
      -0.17020752, -0.9721684,  -0.05806947, 0.66455144,  -0.9861522,
      0.84015197,  0.02706244,  0.7182163,   0.19538581,  -0.26447403,
      -0.13115822, 0.8418238,   -0.05394013, 0.39561734,  -0.36603823,
      -0.46552187, 0.09632338,  -0.03980174, -0.45632786, -0.87531257,
      0.7496608,   0.57642347,  -0.35318395, -0.45223996, -0.8154726,
      0.7437817,   -0.5847761,  0.44290996,  0.48686153,  -0.51036775,
      0.1964353};
  float answ[] = {
      4.33465719e-01,  3.09362411e-02,  -1.21498573e+00, 7.50330210e-01,
      -5.88896573e-01, 3.40205461e-01,  -5.30309558e-01, -2.82787234e-01,
      -7.55091190e-01, 4.48834933e-02,  5.92992544e-01,  -1.20268986e-01,
      1.43259382e+00,  1.12748146e-03,  2.76161969e-01,  -1.78538531e-01,
      -3.81303787e-01, 4.12611991e-01,  -2.43438870e-01, -1.19799149e+00,
      1.63021281e-01,  1.65043736e+00,  7.09975064e-01,  -6.26519918e-01,
      -2.03420687e+00, 7.72354007e-03,  1.64082861e+00,  9.34021711e-01,
      -1.18494534e+00, 8.60727012e-01,  -1.38105774e+00, 1.91074681e+00,
      3.33486485e+00,  1.80288625e+00,  -2.57898629e-01, -8.04997504e-01,
      1.27890217e+00,  1.01139069e-01,  -9.97536123e-01, -4.07600552e-01,
      3.62158716e-02,  -6.25906825e-01, -1.01971030e+00, 2.89445519e-01,
      -3.34729791e-01, -2.75281131e-01, -2.77733654e-01, -1.65930223e+00,
      -1.97788739e+00, 5.34245849e-01,  -9.11256254e-01, -1.49525297e+00,
      -1.27776158e+00, -2.02829003e-01, -2.65641260e+00, -3.29906523e-01,
      5.46819508e-01,  7.33357847e-01,  -2.15138584e-01, -1.31118014e-01,
      -4.64380503e-01, 1.47557437e+00,  -3.17885131e-01, 1.16365242e+00,
      -1.37084633e-01, -1.48007083e+00, -6.12581670e-01, -5.83864033e-01,
      -1.88730896e-01, -4.44947273e-01, 8.22005868e-01,  -6.35574520e-01,
      7.40942955e-01,  4.26556617e-01,  4.52006817e-01,  2.30643606e+00,
      -1.17024779e-02, 1.59966981e+00,  7.47106075e-01,  9.52243805e-01,
      8.03170800e-01};
  create_tensor4d(matmul_src1, (void *)src1, 1, 9, 10, 1);
  create_tensor4d(matmul_src2, (void *)src2, 1, 10, 9, 1);
  create_tensor4d(matmul_dist, (void *)dist, 1, 9, 9, 1);
  create_tensor4d(matmul_answ, (void *)answ, 1, 9, 9, 1);
  matmul(&matmul_dist, &matmul_src1, &matmul_src2);
  float *dst_ptr = (float *)matmul_dist.data;
  float *ans_ptr = (float *)matmul_answ.data;
  EXCEPT_FP32_ARRAY_LAX_EQ(ans_ptr, dst_ptr, 9 * 9,
                           "MATMUL [9 * 10] @ [10, 9]");
}

static void test_matmul2() {
  float src1[] = {
      0.6103098,   0.8255216,   -0.35975635, 0.77283907,  0.67608964,
      -0.03806479, -0.70241445, 0.23275727,  0.53769994,  -0.8578255,
      -0.5156146,  -0.87915987, -0.9085312,  0.5188597,   -0.6801595,
      0.3725819,   -0.17385337, -0.12152246, -0.27631003, 0.8342032,
      -0.7367813,  0.40938675,  -0.7607931,  0.7185413,   -0.8035268,
      -0.0525218,  0.16706277,  -0.09735115, 0.8758925,   -0.45669255,
      0.07801554,  0.01502885,  -0.85549974, -0.22594197, -0.1700427,
      -0.54942346, -0.3532956,  0.22723658,  0.6072588,   -0.90487057,
      0.3981568,   0.26774028,  0.83721304,  -0.20168447, 0.08083999,
      0.21389338,  0.9780312,   0.67795616,  0.06171903,  0.2221395,
      -0.3359374,  -0.23311998, 0.6893883,   0.04596131,  -0.07700885,
      0.74016666,  0.60140634,  0.736337,    -0.50227726, 0.8790556,
      -0.94149184, 0.6748394,   0.00432616,  -0.29951093, 0.07482262,
      -0.9034265,  0.76132,     0.07064518,  -0.70301694, -0.13493322,
      0.09470235,  0.3912155};
  float src2[] = {
      4.6941295e-01,  9.3186408e-01,  -7.5911140e-01, 7.1927005e-01,
      6.1995000e-01,  -3.0891648e-01, 2.3517956e-01,  7.7607358e-01,
      8.4610581e-01,  -4.4463912e-01, -4.4442517e-01, 8.0574907e-02,
      8.8841232e-05,  -1.9194202e-01, -4.2145556e-01, -2.5599852e-01,
      -2.2881601e-02, 5.5650318e-01,  -4.0256473e-01, -2.0933081e-01,
      1.9561585e-02,  3.9730212e-01,  -4.4910613e-01, 7.1199691e-01,
      3.3637524e-01,  -6.9613284e-01, -1.0945515e-01, -5.1395386e-01,
      -4.7152299e-01, 6.7085244e-02,  1.6984358e-01,  1.6624646e-01,
      1.0964852e-01,  9.7344583e-01,  8.6305982e-01,  3.3715323e-01,
      2.1112937e-01,  -4.6142280e-01, 7.2073239e-01,  7.0616192e-01,
      4.1607156e-01,  3.8587677e-01,  -9.0384436e-01, -6.3396192e-01,
      -8.0904406e-01, -1.9966951e-01, -4.0965915e-01, 9.0836614e-01,
      2.9858682e-01,  -8.0918050e-01, 9.5590323e-01,  -5.6018656e-01,
      5.6288671e-01,  -7.9628539e-01};
  float dist[] = {
      0.06390829,  -0.2846071,  0.27084225,  -0.13752297, -0.3666773,
      0.1575223,   -0.3580772,  0.2873811,   -0.5767483,  -0.41270676,
      0.7199194,   0.8855046,   -0.04942373, 0.7355248,   0.03282353,
      0.54418254,  -0.7432518,  -0.26518762, -0.56955355, 0.33206597,
      -0.0480937,  0.12283101,  -0.7577044,  0.96487516,  -0.0783153,
      -0.45868912, -0.27025196, -0.39601925, 0.676875,    -0.7115117,
      0.03499442,  -0.9484264,  -0.69985515, 0.14107108,  0.7476024,
      0.5955806,   -0.7011716,  -0.18849483, 0.41294542,  0.93440884,
      0.18818454,  0.6839822,   -0.02036753, -0.04355457, 0.8667151,
      0.8469528,   -0.33189043, -0.94445646, 0.3594113,   0.45214924,
      -0.22056474, -0.31058705, -0.82082283, -0.95530003, -0.20680735,
      -0.20159028, -0.11302672, -0.6055748,  -0.24141347, 0.14217728,
      -0.6672496,  0.39401662,  -0.23199946, 0.05740863,  0.65256125,
      0.45599625,  -0.34574008, 0.36105415,  0.8117041,   -0.04935804,
      0.6430872,   -0.7424114,  0.19211918,  -0.8272439,  -0.5756079,
      0.16062841,  0.44842303,  -0.8229895,  0.958922,    -0.28058654,
      0.06878375,  -0.49254456, 0.6699961,   0.12580514,  0.8350381,
      -0.4257977,  0.10976938,  -0.17245336, -0.04303304, 0.6326672,
      0.62003917,  0.93418026,  0.8262943,   -0.06189042, 0.00547661,
      -0.01837277, -0.92544913, -0.38620883, -0.643837,   0.36433494,
      0.1461207,   -0.6242617,  0.00631087,  0.04816549,  -0.803058,
      -0.08819018, -0.39664495, -0.85876226};
  float answ[] = {};
  create_tensor4d(matmul_src1, (void *)src1, 1, 12, 6, 1);
  create_tensor4d(matmul_src2, (void *)src2, 1, 6, 9, 1);
  create_tensor4d(matmul_dist, (void *)dist, 1, 12, 9, 1);
  create_tensor4d(matmul_answ, (void *)answ, 1, 12, 9, 1);
  matmul(&matmul_dist, &matmul_src1, &matmul_src2);
  float *dst_ptr = (float *)matmul_dist.data;
  float *ans_ptr = (float *)matmul_answ.data;
  EXCEPT_FP32_ARRAY_LAX_EQ(ans_ptr, dst_ptr, 12 * 9,
                           "MATMUL [12 * 6] @ [6, 9]");
}

int main() {
  test_matmul1();
  test_matmul2();
  return 0;
}