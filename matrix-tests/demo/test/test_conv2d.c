#include "../../isa/utils.h"
#include "../ops/conv2d.h"
#include "../ops/tensor.h"
#include <riscv_matrix.h>

static void test_conv2d1() {
  float src1[] = {-0.5575, -0.4768, 1.1790,  0.8806,  0.0106,  -1.2730, 0.2612,
                  1.2974,  -1.2458, 0.3754,  0.3794,  0.0530,  -0.1756, 0.4102,
                  0.1316,  1.7153,  0.8710,  -1.2900, -1.9218, -0.8618, -0.1458,
                  1.6645,  0.5127,  2.0502,  3.0151,  0.7847,  1.6165,  -1.0945,
                  0.5804,  0.3590,  0.6158,  0.7685,  0.5939,  -0.5187, -0.2314,
                  -0.1572, -0.3269, -0.0862, 1.2765,  0.2962,  -2.1301, 1.0471,
                  -1.2341, 0.8408,  -0.1447, 0.0521,  -1.7101, -0.0908, -0.7263,
                  0.3431,  -1.3718, 0.2189,  -1.1996, 1.7766,  -0.0438, 0.4875,
                  -0.1058, 0.9646,  0.1644,  1.1626,  -0.6059, 2.0560,  0.4336,
                  -1.7077, -1.4374, -1.1227, -1.4177, 1.0227,  0.2949,  1.9706,
                  0.4489,  1.5087,  -1.3713, -0.8765, -1.6935};
  float src2[] = {
      0.0373,  0.1017,  0.0186,  -0.1105, 0.1023,  -0.1610, -0.0097, 0.1031,
      0.1836,  0.1861,  -0.0353, 0.1529,  -0.0834, 0.1574,  0.1566,  -0.0464,
      -0.1631, 0.0161,  0.1469,  -0.0461, 0.1637,  -0.0698, 0.0058,  -0.1907,
      -0.0393, 0.0549,  0.0532,  0.1037,  0.0935,  0.0501,  0.0087,  0.1364,
      -0.0099, 0.0538,  -0.1011, -0.1910, -0.1538, -0.1033, -0.0557, 0.1161,
      -0.1832, 0.1438,  -0.0347, -0.1239, -0.1819, -0.0316, 0.1554,  0.1566,
      -0.0807, -0.1877, -0.0101, -0.1144, 0.1440,  -0.0257, -0.0768, -0.0164,
      0.1724,  0.1094,  0.1864,  0.0922,  -0.1481, 0.0771,  -0.1378, 0.1532,
      0.1362,  0.1529,  0.0010,  -0.0113, -0.0239, 0.0112,  0.0562,  0.0352,
      0.0633,  0.1668,  -0.1456, 0.0369,  0.1770,  0.0336,  -0.0271, -0.1854,
      -0.1759, 0.1071,  -0.1807, 0.1566,  0.0855,  0.1436,  -0.0841, -0.1302,
      -0.1772, 0.1016,  0.1669,  -0.0474, -0.0674, 0.0742,  -0.0998, -0.0617,
      0.1729,  0.1286,  -0.0861, 0.0615,  0.1901,  -0.0342, 0.1262,  0.0873,
      -0.1456, 0.1612,  0.0859,  0.0961,  -0.0997, -0.1232, 0.1201,  0.0900,
      -0.1768, 0.1065,  -0.0689, -0.1365, -0.0578, 0.0813,  0.0416,  0.1534,
      0.1598,  -0.0611, -0.0568, 0.1188,  -0.0051, -0.0970, 0.1841,  0.1889,
      0.0368,  -0.1778, 0.1614,  0.1668,  0.0480,  0.0212,  -0.0856, 0.0017,
      -0.0512, -0.0368, -0.0072, -0.1878, -0.1406, -0.0028, -0.0961, 0.0124,
      0.0104,  0.0556,  0.0821,  0.1716,  -0.0239, -0.0164, 0.0353,  -0.0314,
      0.1207,  0.1604,  -0.1888, 0.0431,  -0.1850, -0.1372, 0.0987,  0.1380,
      -0.0822, 0.0710};
  float ans[] = {-0.0962, -0.5309, 0.3087,  0.9559,  -0.0263, 0.6307,  1.1282,
                 -0.0319, -1.7212, -0.0995, 0.1066,  0.0440,  0.4439,  0.3670,
                 -0.5860, 0.4780,  1.1689,  0.8987,  -1.0128, -0.2791, -0.3214,
                 0.4351,  0.6972,  0.3980,  -0.6168, -1.0421, -0.4748, -0.1657,
                 -1.2465, 0.4039,  0.7198,  1.3149,  1.2974,  -0.3695, 0.3400,
                 -1.5444, -0.4427, -1.0190, 0.4465,  0.4599,  -0.1996, -0.0686,
                 -0.1953, 0.8054,  0.2047,  0.1690,  -0.8471, -1.0146, 1.4241,
                 0.3684,  -0.9478, -1.1571, 0.5083,  -0.1625};
  const int B = 1;
  const int C = 3;
  const int H = 5;
  const int W = 5;
  float dst[3 * 3 * 6];
  create_conv2d_default_config(cfg, 1, 0, 1, 3);
  create_tensor4d(conv_src1, (void *)src1, B, H, W, C);
  create_tensor4d(conv_src2, (void *)src2, 3, 3, C, 6);
  create_tensor4d(conv_dst, (void *)dst, B, 3, 3, 6);
  create_tensor4d(conv_ans, (void *)ans, B, 3, 3, 6);
  conv2d(&conv_dst, &conv_src1, &conv_src2, &cfg);
  float *dst_ptr = (float *)conv_dst.data;
  float *ans_ptr = (float *)conv_ans.data;
  EXCEPT_FP32_ARRAY_LAX_EQ(ans_ptr, dst_ptr, 6 * 6 * C, "CONV2D [1, 5, 5, 3]");
}

int main() {
  test_conv2d1();
  return 0;
}
