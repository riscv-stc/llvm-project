#include "utils.h"
#include <riscv_matrix.h>

static void test_mfdiv_mm() {
  // M1
  // fp16
  msettype(E16, M1, BA);
  msettilemi(3);
  msettileni(8);
  const fp16_t fp16_src1[] = {
      -0.641, 1.274,   -0.5757, 0.7256,  -1.534,  0.593,   -1.165,  2.162,
      0.2944, -0.714,  0.2566,  -0.3442, -0.669,  -0.6343, 0.117,   -1.321,
      0.636,  -0.1808, 0.8984,  -0.2937, -0.6978, -1.882,  0.04224, 1.137};
  const fp16_t fp16_src2[] = {
      1.129,   0.4475,  -0.5806, -1.445,  0.307,   2.766,  0.08813, -1.221,
      -0.1545, 0.2212,  -0.1305, -0.9863, -0.9478, 0.6777, -1.476,  -0.394,
      -0.8354, 0.05124, -0.1344, 0.1136,  -0.4602, 0.4934, -1.589,  1.027};
  const fp16_t fp16_ans[] = {-0.568, 2.848,  0.9917,  -0.502, -5.,      0.2144,
                             -13.22, -1.771, -1.905,  -3.227, -1.967,   0.349,
                             0.706,  -0.936, -0.0793, 3.354,  -0.7617,  -3.527,
                             -6.684, -2.586, 1.517,   -3.814, -0.02658, 1.106};
  mfloat16m1_t fp16_ts1 = mlce16_m1(fp16_src1, 8 * sizeof(fp16_t));
  mfloat16m1_t fp16_ts2 = mlce16_m1(fp16_src2, 8 * sizeof(fp16_t));
  mfloat16m1_t fp16_out = mfdiv_mm(fp16_ts1, fp16_ts2);
  msce16_m(fp16_out, fp16_buffer, 8 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans, fp16_buffer, 24, "  MFDIV.MM FP16   M1");
  // fp32
  msettype(E32, M1, BA);
  msettilemi(4);
  msettileni(4);
  const fp32_t fp32_src1[] = {
      -0.4690982, -0.28848022, -0.23181526, -2.0541718, 0.18218172, 0.7917702,
      0.6092491,  0.19054824,  -0.5287594,  0.13876893, 0.00224436, -1.4519596,
      2.015604,   1.2912354,   -1.2530205,  -0.25601363};
  const fp32_t fp32_src2[] = {-0.84642494, 0.16054851, -1.7505393, -0.3455231,
                              -0.19710808, 0.10227215, 0.12655504, 0.8003212,
                              0.9909784,   0.17909421, -1.3823507, -0.78190917,
                              -1.4348396,  -1.1776177, 0.6670935,  1.7894806};
  const fp32_t fp32_ans[] = {
      5.5421126e-01,  -1.7968415e+00, 1.3242505e-01,  5.9451070e+00,
      -9.2427325e-01, 7.7417970e+00,  4.8141041e+00,  2.3808970e-01,
      -5.3357309e-01, 7.7483761e-01,  -1.6235833e-03, 1.8569416e+00,
      -1.4047592e+00, -1.0964811e+00, -1.8783281e+00, -1.4306588e-01};
  mfloat32m1_t fp32_ts1 = mlce32_m1(fp32_src1, 4 * sizeof(fp32_t));
  mfloat32m1_t fp32_ts2 = mlce32_m1(fp32_src2, 4 * sizeof(fp32_t));
  mfloat32m1_t fp32_out = mfdiv_mm(fp32_ts1, fp32_ts2);
  msce32_m(fp32_out, fp32_buffer, 4 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans, fp32_buffer, 16, "  MFDIV.MM FP32   M1");
  // fp64
  msettype(E64, M1, BA);
  msettilemi(5);
  msettileni(2);
  const fp64_t fp64_src1[] = {-0.98383261, -0.3942304, -0.15611482, 2.16339874,
                              -0.74209649, -1.5500069, -1.62072863, -0.54966375,
                              0.54711649,  -1.22067194};
  const fp64_t fp64_src2[] = {-2.61784465, 0.02490006, 1.32696526, 0.74632626,
                              0.91131296,  1.1365966,  0.20496439, -1.32838022,
                              -0.1165156,  -0.94767632};
  const fp64_t fp64_ans[] = {0.3758178,   -15.83251037, -0.11764801, 2.89873057,
                             -0.81431575, -1.3637265,   -7.90736696, 0.41378496,
                             -4.6956503,  1.28806841};
  mfloat64m1_t fp64_ts1 = mlce64_m1(fp64_src1, 2 * sizeof(fp64_t));
  mfloat64m1_t fp64_ts2 = mlce64_m1(fp64_src2, 2 * sizeof(fp64_t));
  mfloat64m1_t fp64_out = mfdiv_mm(fp64_ts1, fp64_ts2);
  msce64_m(fp64_out, fp64_buffer, 2 * sizeof(fp64_t));
  EXCEPT_FP64_ARRAY_LAX_EQ(fp64_ans, fp64_buffer, 10, "  MFDIV.MM FP64   M1");
  // M2
  // fp16
  msettype(E16, M2, BA);
  msettilemi(2);
  msettileni(16);
  const fp16_t fp16_src1_m2[] = {
      -9.78,  -6.55,   -2.03, 8.1,   6.89,   4.62,  -8.95,  -8.53,
      9.89,   -9.625,  1.946, 3.617, -1.256, 4.133, -5.547, 2.514,
      -4.277, 6.008,   5.715, -7.17, 7.227,  5.31,  -8.016, 3.8,
      -6.91,  -0.9478, -8.93, 3.336, 2.611,  6.094, 6.355,  5.35};
  const fp16_t fp16_src2_m2[] = {
      8.58,  -1.287, -2.771, 9.72,   8.016,   -0.49, -2.346, 5.094,
      6.785, 7.656,  6.54,   -3.902, -0.7617, -9.58, -8.586, -6.074,
      -8.23, 1.072,  -5.277, -4.836, -2.232,  -8.03, 8.45,   3.5,
      2.11,  -5.37,  7.566,  -7.2,   -9.875,  4.43,  -9.65,  3.38};
  const fp16_t fp16_ans_m2[] = {
      -1.141, 5.09,   0.7324, 0.8335,  0.86,    -9.43,   3.816,   -1.675,
      1.458,  -1.257, 0.2976, -0.927,  1.648,   -0.4314, 0.646,   -0.4138,
      0.52,   5.6,    -1.083, 1.483,   -3.236,  -0.661,  -0.948,  1.086,
      -3.275, 0.1765, -1.18,  -0.4634, -0.2644, 1.376,   -0.6587, 1.583};
  mfloat16m2_t fp16_ts1_m2 = mlce16_m2(fp16_src1_m2, 16 * sizeof(fp16_t));
  mfloat16m2_t fp16_ts2_m2 = mlce16_m2(fp16_src2_m2, 16 * sizeof(fp16_t));
  mfloat16m2_t fp16_out_m2 = mfdiv_mm(fp16_ts1_m2, fp16_ts2_m2);
  msce16_m(fp16_out_m2, fp16_buffer, 16 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m2, fp16_buffer, 2 * 16,
                           "  MFDIV.MM FP16   M2");
  // fp32
  msettype(E32, M2, BA);
  msettilemi(3);
  msettileni(8);
  const fp32_t fp32_src1_m2[] = {
      -1.0723377, 1.0846838,  -7.240781,  -2.7056706, 3.8086436,  6.670786,
      -7.101239,  5.7829175,  -7.0197916, -6.2308145, 9.203428,   -2.9899569,
      6.52373,    -4.3414907, 1.6695228,  -1.5630258, -7.9816804, 7.384688,
      6.5741687,  -4.1732497, -1.2234977, -3.0332417, 4.5633683,  0.47667888};
  const fp32_t fp32_src2_m2[] = {
      -2.78065,   8.889991,  6.238808,   2.2441697,  4.791139,   -4.5401535,
      6.5373073,  -5.596464, -1.2234693, -8.888672,  4.482698,   -1.3508967,
      -7.5592365, 4.8249707, -3.2596362, 3.5143325,  8.581369,   -9.399546,
      3.0543656,  9.074719,  -1.1511564, -5.2569246, 0.13160211, -5.186906};
  const fp32_t fp32_ans_m2[] = {
      0.38564286,  0.1220118,  -1.1606032,  -1.2056444, 0.79493487,
      -1.4692864,  -1.0862637, -1.0333163,  5.737612,   0.70098376,
      2.0531003,   2.2133126,  -0.8630144,  -0.8997963, -0.5121807,
      -0.44475752, -0.9301173, -0.78564304, 2.1523843,  -0.45987645,
      1.0628422,   0.5769993,  34.675495,   -0.09190043};
  mfloat32m2_t fp32_ts1_m2 = mlce32_m2(fp32_src1_m2, 8 * sizeof(fp32_t));
  mfloat32m2_t fp32_ts2_m2 = mlce32_m2(fp32_src2_m2, 8 * sizeof(fp32_t));
  mfloat32m2_t fp32_out_m2 = mfdiv_mm(fp32_ts1_m2, fp32_ts2_m2);
  msce32_m(fp32_out_m2, fp32_buffer, 8 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans_m2, fp32_buffer, 3 * 8,
                           " MFDIV.MM FP32   M2");
  // fp64
  msettype(E64, M2, BA);
  msettilemi(4);
  msettileni(4);
  const fp64_t fp64_src1_m2[] = {
      -9.27037998, 2.26703033,  -0.48263241, -7.76920802,
      -4.79504417, -0.29753203, -8.71887224, -0.71918141,
      2.95856026,  -7.83273194, -2.14882548, 1.18035783,
      6.34378632,  6.60879884,  -7.98645134, 7.03515968};
  const fp64_t fp64_src2_m2[] = {
      -0.29281738, 5.37127143,  -6.12932688, -5.51180981,
      3.74220626,  -1.41971855, -3.19271582, 6.03043921,
      -7.88715509, -8.78622145, 6.37353653,  -0.52992982,
      5.97604128,  -7.42948774, 9.35900553,  -5.17140614};
  const fp64_t fp64_ans_m2[] = {
      31.65925426, 0.42206587,  0.0787415,   1.40955662,
      -1.2813415,  0.20957113,  2.73086386,  -0.11925855,
      -0.37511121, 0.891479,    -0.33714806, -2.22738519,
      1.06153656,  -0.88953627, -0.85334401, -1.36039589};
  mfloat64m2_t fp64_ts1_m2 = mlce64_m2(fp64_src1_m2, 4 * sizeof(fp64_t));
  mfloat64m2_t fp64_ts2_m2 = mlce64_m2(fp64_src2_m2, 4 * sizeof(fp64_t));
  mfloat64m2_t fp64_out_m2 = mfdiv_mm(fp64_ts1_m2, fp64_ts2_m2);
  msce64_m(fp64_out_m2, fp64_buffer, 4 * sizeof(fp64_t));
  EXCEPT_FP64_ARRAY_LAX_EQ(fp64_ans_m2, fp64_buffer, 4 * 4,
                           " MFDIV.MM FP64   M2");
  // M4
  // fp16
  msettype(E16, M4, BA);
  msettilemi(2);
  msettileni(17);
  const fp16_t fp16_src1_m4[] = {
      4.293, -0.5225, -0.01675, 7.234,  -3.955, -4.863, 8.5,   -2.783, 4.664,
      7.598, -3.928,  -6.008,   6.99,   -2.969, -8.4,   1.336, 0.825,  2.73,
      0.582, 7.207,   -1.767,   2.645,  -1.048, -1.649, 3.436, -8.484, -2.28,
      1.506, -3.191,  -6.348,   0.2458, 8.97,   5.73,   -5.645};
  const fp16_t fp16_src2_m4[] = {
      -9.34,  2.826,  9.664,  -1.824, -3.53,  -2.777, -2.348, -8.51,  2.93,
      -4.707, 3.824,  8.66,   0.4478, 7.016,  2.662,  5.996,  -3.941, -2.256,
      -2.684, 2.822,  -5.43,  6.547,  9.164,  -2.79,  -0.379, -8.98,  8.52,
      -2.059, -6.348, -1.971, -6.895, -7.418, 4.14,   2.076};
  const fp16_t fp16_ans_m4[] = {
      -4.595e-01, -1.848e-01, -1.734e-03, -3.965e+00, 1.121e+00,  1.751e+00,
      -3.621e+00, 3.271e-01,  1.592e+00,  -1.614e+00, -1.027e+00, -6.938e-01,
      1.561e+01,  -4.231e-01, -3.154e+00, 2.228e-01,  -2.094e-01, -1.210e+00,
      -2.169e-01, 2.553e+00,  3.254e-01,  4.041e-01,  -1.143e-01, 5.913e-01,
      -9.070e+00, 9.453e-01,  -2.673e-01, -7.314e-01, 5.029e-01,  3.221e+00,
      -3.564e-02, -1.209e+00, 1.384e+00,  -2.719e+00};
  mfloat16m4_t fp16_ts1_m4 = mlce16_m4(fp16_src1_m4, 17 * sizeof(fp16_t));
  mfloat16m4_t fp16_ts2_m4 = mlce16_m4(fp16_src2_m4, 17 * sizeof(fp16_t));
  mfloat16m4_t fp16_out_m4 = mfdiv_mm(fp16_ts1_m4, fp16_ts2_m4);
  msce16_m(fp16_out_m4, fp16_buffer, 17 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m4, fp16_buffer, 2 * 17,
                           " MFDIV.MM FP16   M4");
  // fp32
  msettype(E32, M4, BA);
  msettilemi(3);
  msettileni(9);
  const fp32_t fp32_src1_m4[] = {
      9.00379,     -5.8617597, -8.456596, 2.4125102,  1.7198021,  9.0185375,
      -0.01912716, 4.976258,   4.441573,  2.479429,   -9.056509,  -5.438199,
      2.8354576,   -9.515016,  9.991996,  -4.71372,   3.3510113,  -6.935938,
      -8.092153,   -1.3373569, 7.2433763, -3.1689456, -2.1851583, 4.1306663,
      -1.3684416,  -9.61416,   -6.1799135};
  const fp32_t fp32_src2_m4[] = {
      2.883744,   6.9604077,   2.7148821,  -5.7053037, -8.290875,   -3.7200482,
      6.154701,   7.0206933,   -5.2301497, 6.800394,   -0.9019678,  7.206488,
      -7.6236978, -0.40614307, -3.9574645, -3.7425184, -0.16515483, 9.595156,
      -1.5147163, -0.9940132,  -5.7299886, 1.460166,   -9.303591,   0.6468225,
      -9.40256,   9.468916,    7.9712124};
  const fp32_t fp32_ans_m4[] = {
      3.1222570e+00,  -8.4215748e-01, -3.1149037e+00, -4.2285395e-01,
      -2.0743312e-01, -2.4243066e+00, -3.1077324e-03, 7.0879865e-01,
      -8.4922487e-01, 3.6460078e-01,  1.0040833e+01,  -7.5462538e-01,
      -3.7192681e-01, 2.3427744e+01,  -2.5248480e+00, 1.2595048e+00,
      -2.0290119e+01, -7.2285831e-01, 5.3423553e+00,  1.3454117e+00,
      -1.2641170e+00, -2.1702640e+00, 2.3487256e-01,  6.3860893e+00,
      1.4553925e-01,  -1.0153390e+00, -7.7527899e-01};
  mfloat32m4_t fp32_ts1_m4 = mlce32_m4(fp32_src1_m4, 9 * sizeof(fp32_t));
  mfloat32m4_t fp32_ts2_m4 = mlce32_m4(fp32_src2_m4, 9 * sizeof(fp32_t));
  mfloat32m4_t fp32_out_m4 = mfdiv_mm(fp32_ts1_m4, fp32_ts2_m4);
  msce32_m(fp32_out_m4, fp32_buffer, 9 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans_m4, fp32_buffer, 3 * 9,
                           " MFDIV.MM FP32   M4");
  // fp64
  msettype(E64, M4, BA);
  msettilemi(4);
  msettileni(5);
  const fp64_t fp64_src1_m4[] = {
      -1.15166251, -5.42031882, -7.68336288, 8.36525699, -3.83356384,
      5.59771786,  -2.67906036, -4.27337185, 0.41281164, -4.86869887,
      8.41306164,  -0.45559843, 7.38046409,  7.5211951,  -2.01959192,
      1.17114537,  -0.36481728, 8.84565949,  9.50075858, 0.64737648};
  const fp64_t fp64_src2_m4[] = {
      -3.06966673, 5.74172205,  9.00342371,  -5.40155615, 9.84679352,
      -9.13054054, 1.24626593,  7.14190955,  -2.82882129, 0.51755187,
      6.46609565,  -7.94961507, -4.50077668, -4.0063604,  1.24182384,
      -1.33513869, -5.74378714, 9.75602159,  2.36783816,  6.00626318};
  const fp64_t fp64_ans_m4[] = {
      0.3751751,   -0.9440232,  -0.85338235, -1.54867537, -0.38932104,
      -0.61307628, -2.14966991, -0.59835144, -0.14593062, -9.40717078,
      1.3011038,   0.05731075,  -1.63982011, -1.87731366, -1.62631112,
      -0.87717132, 0.06351511,  0.90668716,  4.01241889,  0.10778357};
  mfloat64m4_t fp64_ts1_m4 = mlce64_m4(fp64_src1_m4, 5 * sizeof(fp64_t));
  mfloat64m4_t fp64_ts2_m4 = mlce64_m4(fp64_src2_m4, 5 * sizeof(fp64_t));
  mfloat64m4_t fp64_out_m4 = mfdiv_mm(fp64_ts1_m4, fp64_ts2_m4);
  msce64_m(fp64_out_m4, fp64_buffer, 5 * sizeof(fp64_t));
  EXCEPT_FP64_ARRAY_LAX_EQ(fp64_ans_m4, fp64_buffer, 4 * 5,
                           " MFDIV.MM FP64   M4");
}

static void test_mfsqrt_m() {
  // M1
  // fp16
  msettype(E16, M1, BA);
  msettilemi(3);
  msettileni(8);
  const fp16_t fp16_src1[] = {1.753,  0.6,    1.264,  1.617,  1.481,  0.0896,
                              1.059,  1.682,  0.7407, 0.4924, 0.2542, 0.801,
                              0.7554, 0.6846, 0.277,  1.899,  0.7837, 0.6743,
                              1.559,  0.883,  1.686,  0.7046, 0.2256, 0.8877};
  const fp16_t fp16_ans[] = {1.324, 0.7744, 1.124,  1.271,  1.217,  0.2993,
                             1.028, 1.297,  0.8604, 0.7017, 0.5044, 0.895,
                             0.869, 0.827,  0.5264, 1.378,  0.8853, 0.8213,
                             1.248, 0.9395, 1.299,  0.8394, 0.475,  0.9424};
  mfloat16m1_t fp16_ts1 = mlce16_m1(fp16_src1, 8 * sizeof(fp16_t));
  mfloat16m1_t fp16_out = mfsqrt_m(fp16_ts1);
  msce16_m(fp16_out, fp16_buffer, 8 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans, fp16_buffer, 24, "MFSQRT.MM FP16 M1");
  // fp32
  msettype(E32, M1, BA);
  msettilemi(4);
  msettileni(4);
  const fp32_t fp32_src1[] = {0.6894772,  0.71411985, 0.00213574, 0.84077483,
                              0.7537378,  1.8758334,  0.33491394, 0.78118384,
                              0.00986264, 0.3721463,  0.47278303, 1.5777247,
                              1.572349,   0.25314808, 1.1858083,  0.28583416};
  const fp32_t fp32_ans[] = {0.83034766, 0.8450561,  0.04621406, 0.91693777,
                             0.86818075, 1.3696107,  0.57871747, 0.88384604,
                             0.09931084, 0.610038,   0.6875922,  1.2560751,
                             1.2539334,  0.50313824, 1.0889482,  0.5346346};
  mfloat32m1_t fp32_ts1 = mlce32_m1(fp32_src1, 4 * sizeof(fp32_t));
  mfloat32m1_t fp32_out = mfsqrt_m(fp32_ts1);
  msce32_m(fp32_out, fp32_buffer, 4 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans, fp32_buffer, 16, "MFSQRT.MM FP32 M1");
  // fp64
  msettype(E64, M1, BA);
  msettilemi(5);
  msettileni(2);
  const fp64_t fp64_src1[] = {1.31225901, 0.54779544, 0.79171655, 1.66375992,
                              1.43298659, 1.57364875, 1.4639339,  0.75096326,
                              1.96519337, 1.50664328};
  const fp64_t fp64_ans[] = {1.14553874, 0.74013204, 0.88978455, 1.28986818,
                             1.19707418, 1.25445158, 1.20993136, 0.86658136,
                             1.40185355, 1.22745398};
  mfloat64m1_t fp64_ts1 = mlce64_m1(fp64_src1, 2 * sizeof(fp64_t));
  mfloat64m1_t fp64_out = mfsqrt_m(fp64_ts1);
  msce64_m(fp64_out, fp64_buffer, 2 * sizeof(fp64_t));
  EXCEPT_FP64_ARRAY_LAX_EQ(fp64_ans, fp64_buffer, 10, "MFSQRT.MM FP64 M1");
  // M2
  // fp16
  msettype(E16, M2, BA);
  msettilemi(2);
  msettileni(16);
  const fp16_t fp16_src1_m2[] = {
      7.375, 0.3535, 5.965, 5.785, 0.6924, 5.91,   1.913, 5.82,
      4.555, 9.586,  5.9,   9.99,  5.47,   4.168,  3.637, 3.506,
      9.38,  1.472,  8.164, 7.24,  5.633,  0.7964, 9.79,  4.438,
      8.7,   4.74,   9.58,  8.914, 8.52,   3.809,  3.81,  2.754};
  const fp16_t fp16_ans_m2[] = {
      2.715, 0.5947, 2.441, 2.404, 0.832, 2.432,  1.383, 2.412,
      2.135, 3.096,  2.428, 3.16,  2.338, 2.041,  1.907, 1.872,
      3.062, 1.213,  2.857, 2.69,  2.373, 0.8926, 3.129, 2.107,
      2.95,  2.178,  3.096, 2.986, 2.92,  1.951,  1.952, 1.659};
  mfloat16m2_t fp16_ts1_m2 = mlce16_m2(fp16_src1_m2, 16 * sizeof(fp16_t));
  mfloat16m2_t fp16_out_m2 = mfsqrt_m(fp16_ts1_m2);
  msce16_m(fp16_out_m2, fp16_buffer, 16 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m2, fp16_buffer, 2 * 16,
                           "MFSQRT.MM FP16 M2");
  // fp32
  msettype(E32, M2, BA);
  msettilemi(3);
  msettileni(8);
  const fp32_t fp32_src1_m2[] = {
      7.707274,  7.5940504, 1.9185019, 1.9740413, 2.7537847,  7.5529866,
      2.9084897, 5.182068,  5.23053,   8.590826,  3.3726425,  3.8152487,
      5.3716297, 6.1565804, 7.358675,  9.296577,  0.71664655, 8.918199,
      5.107533,  8.087339,  4.797194,  4.574916,  7.823366,   7.2707047};
  const fp32_t fp32_ans_m2[] = {
      2.7761977, 2.7557304, 1.3850999, 1.4050058, 1.6594532, 2.7482698,
      1.7054294, 2.2764156, 2.2870352, 2.9310112, 1.8364756, 1.9532661,
      2.3176777, 2.4812458, 2.7126877, 3.0490289, 0.8465498, 2.9863353,
      2.2599852, 2.8438249, 2.1902497, 2.1389053, 2.797028,  2.6964245};
  mfloat32m2_t fp32_ts1_m2 = mlce32_m2(fp32_src1_m2, 8 * sizeof(fp32_t));
  mfloat32m2_t fp32_out_m2 = mfsqrt_m(fp32_ts1_m2);
  msce32_m(fp32_out_m2, fp32_buffer, 8 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans_m2, fp32_buffer, 3 * 8,
                           "MFSQRT.MM FP32 M2");
  // fp64
  msettype(E64, M2, BA);
  msettilemi(4);
  msettileni(4);
  const fp64_t fp64_src1_m2[] = {
      8.13899948, 1.91852238, 7.40387446, 4.71924446, 7.7818608,  6.89339968,
      7.0113651,  4.48101134, 6.50267147, 9.38791839, 3.21827255, 9.7269389,
      4.81798545, 5.73011697, 3.1768537,  6.36559576};
  const fp64_t fp64_ans_m2[] = {2.85289318, 1.38510735, 2.72100615, 2.17238221,
                                2.78959868, 2.62552846, 2.64789824, 2.11683994,
                                2.55003362, 3.06397102, 1.79395444, 3.11880408,
                                2.19499099, 2.39376627, 1.78237305, 2.52301323};
  mfloat64m2_t fp64_ts1_m2 = mlce64_m2(fp64_src1_m2, 4 * sizeof(fp64_t));
  mfloat64m2_t fp64_out_m2 = mfsqrt_m(fp64_ts1_m2);
  msce64_m(fp64_out_m2, fp64_buffer, 4 * sizeof(fp64_t));
  EXCEPT_FP64_ARRAY_LAX_EQ(fp64_ans_m2, fp64_buffer, 4 * 4,
                           "MFSQRT.MM FP64 M2");
  // M4
  // fp16
  msettype(E16, M4, BA);
  msettilemi(2);
  msettileni(17);
  const fp16_t fp16_src1_m4[] = {
      7.02,  6.93,  7.24,   4.465, 1.809, 3.246, 1.125, 8.984, 6.566,
      5.094, 1.631, 8.38,   2.078, 6.395, 6.63,  2.912, 7.47,  4.914,
      4.93,  5.68,  8.79,   8.07,  4.37,  4.6,   9.15,  9.805, 1.873,
      2.436, 3.451, 1.8125, 2.924, 3.105, 8.33,  6.758};
  const fp16_t fp16_ans_m4[] = {2.65,  2.633, 2.69,  2.113, 1.345, 1.802, 1.061,
                                2.998, 2.562, 2.258, 1.277, 2.895, 1.441, 2.53,
                                2.574, 1.706, 2.732, 2.217, 2.22,  2.383, 2.965,
                                2.842, 2.09,  2.145, 3.025, 3.13,  1.368, 1.561,
                                1.857, 1.347, 1.71,  1.763, 2.887, 2.6};
  mfloat16m4_t fp16_ts1_m4 = mlce16_m4(fp16_src1_m4, 17 * sizeof(fp16_t));
  mfloat16m4_t fp16_out_m4 = mfsqrt_m(fp16_ts1_m4);
  msce16_m(fp16_out_m4, fp16_buffer, 17 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m4, fp16_buffer, 2 * 17,
                           "MFSQRT.MM FP16 M4");
  // fp32
  msettype(E32, M4, BA);
  msettilemi(3);
  msettileni(9);
  const fp32_t fp32_src1_m4[] = {
      8.008892,  3.039322,  2.4527104, 6.87497,   6.5655603, 2.1702096,
      1.8647846, 7.297751,  3.6710892, 5.287184,  1.728847,  8.094283,
      0.9847609, 6.1942277, 5.2805505, 1.244854,  2.8872964, 9.575491,
      3.849513,  5.5630293, 5.3279047, 6.0255103, 3.152453,  7.25097,
      8.532427,  8.706653,  9.038486};
  const fp32_t fp32_ans_m4[] = {
      2.8299985, 1.743365,  1.5661131, 2.6220164, 2.562335,  1.4731631,
      1.3655711, 2.701435,  1.9160087, 2.2993877, 1.3148563, 2.8450453,
      0.9923512, 2.4888206, 2.2979448, 1.1157303, 1.6992047, 3.094429,
      1.9620177, 2.3586075, 2.3082254, 2.4546914, 1.7755148, 2.6927626,
      2.9210317, 2.9507039, 3.0064075};
  mfloat32m4_t fp32_ts1_m4 = mlce32_m4(fp32_src1_m4, 9 * sizeof(fp32_t));
  mfloat32m4_t fp32_out_m4 = mfsqrt_m(fp32_ts1_m4);
  msce32_m(fp32_out_m4, fp32_buffer, 9 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans_m4, fp32_buffer, 3 * 9,
                           "MFSQRT.MM FP32 M4");
  // fp64
  msettype(E64, M4, BA);
  msettilemi(4);
  msettileni(5);
  const fp64_t fp64_src1_m4[] = {
      6.19058648, 7.64107527, 0.94157335, 2.58177761, 6.55215417,
      4.93442574, 1.33886154, 1.8146612,  3.37703548, 2.43903844,
      5.5541449,  8.1194245,  7.9091309,  7.95096394, 8.98363778,
      8.83279654, 6.18772576, 2.53770811, 7.90228706, 6.15191448};
  const fp64_t fp64_ans_m4[] = {2.48808892, 2.7642495,  0.97034702, 1.60679109,
                                2.5597176,  2.22135673, 1.15709184, 1.34709361,
                                1.83767121, 1.56174212, 2.35672334, 2.84946039,
                                2.81231771, 2.81974537, 2.99727172, 2.97200211,
                                2.48751397, 1.59301855, 2.81110068, 2.48030532};
  mfloat64m4_t fp64_ts1_m4 = mlce64_m4(fp64_src1_m4, 5 * sizeof(fp64_t));
  mfloat64m4_t fp64_out_m4 = mfsqrt_m(fp64_ts1_m4);
  msce64_m(fp64_out_m4, fp64_buffer, 5 * sizeof(fp64_t));
  EXCEPT_FP64_ARRAY_LAX_EQ(fp64_ans_m4, fp64_buffer, 4 * 5,
                           "MFSQRT.MM FP64 M4");
}

int main() {
  test_mfdiv_mm();
  test_mfsqrt_m();
  return 0;
}