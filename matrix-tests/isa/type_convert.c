#include "utils.h"
#include <riscv_matrix.h>

static void test_mfncvt_fw_f_m() {
  // M1
  // fp16 -> fp32
  msettype(E16, M1, BA);
  msettilemi(3);
  msettileni(8);
  const fp16_t fp16_src[] = {40.1,   -62.4, -8.29,   -22.97, -98.75, -35.28,
                             0.621,  1.525, -12.44,  36.94,  -37.22, -35.7,
                             70.56,  25.42, -12.516, -96.6,  67.9,   -77.56,
                             -4.848, 62.3,  6.55,    -64.1,  -66.7,  -21.14};
  const fp32_t fp32_ans[] = {
      40.09375,   -62.40625, -8.2890625, -22.96875, -98.75,    -35.28125,
      0.62109375, 1.5253906, -12.4375,   36.9375,   -37.21875, -35.6875,
      70.5625,    25.421875, -12.515625, -96.625,   67.875,    -77.5625,
      -4.8476562, 62.3125,   6.5507812,  -64.125,   -66.6875,  -21.140625};
  mfloat16m1_t fp16_ts = mlce16_m1(fp16_src, 8 * sizeof(fp16_t));
  mfloat32m2_t fp32_out = mfwcvt_fw_f_m(fp16_ts);
  msettype(E32, M2, BA);
  msettileni(8);
  msce32_m(fp32_out, fp32_buffer, 8 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans, fp32_buffer, 3 * 8,
                           "  MFWCVT.FW.F.M  FP16   M1");
  // fp32 -> fp64
  msettype(E32, M1, BA);
  msettilemi(4);
  msettileni(4);
  const fp32_t fp32_src[] = {92.50363,   -2.318218, 93.97482,  65.441475,
                             -84.86822,  24.415392, -36.24902, 49.815197,
                             -89.18823,  -79.92042, -68.71595, -80.57456,
                             -15.476303, -86.14968, 56.33225,  -53.008804};
  const fp64_t fp64_ans[] = {
      92.50363159,  -2.31821799,  93.974823,    65.44147491,
      -84.86821747, 24.41539192,  -36.24901962, 49.81519699,
      -89.18823242, -79.92041779, -68.71595001, -80.57456207,
      -15.4763031,  -86.14968109, 56.33224869,  -53.00880432};
  mfloat32m1_t fp32_ts = mlce32_m1(fp32_src, 4 * sizeof(fp32_t));
  mfloat64m2_t fp64_out = mfwcvt_fw_f_m(fp32_ts);
  msettype(E64, M2, BA);
  msettileni(4);
  msce64_m(fp64_out, fp64_buffer, 4 * sizeof(fp64_t));
  EXCEPT_FP64_ARRAY_LAX_EQ(fp64_ans, fp64_buffer, 4 * 4,
                           "  MFWCVT.FW.F.M  FP32   M1");
  // M2
  // fp16 -> fp32
  msettype(E16, M2, BA);
  msettilemi(3);
  msettileni(16);
  const fp16_t fp16_src_m2[] = {
      9.35,   -1.724, -2.16,  3.924,  -2.418, -5.66,  -4.234,  5.188,
      7.04,   -7.73,  -7.85,  3.896,  -4.742, -6.38,  1.178,   -0.9507,
      3.162,  -1.274, -1.08,  -9.125, -2.125, -9.41,  3.54,    -4.574,
      -7.094, 6.77,   -2.936, -5.008, -2.225, -5.867, -0.4377, -2.695,
      7.11,   8.7,    -9.734, -6.52,  -6.855, -3.818, 5.906,   -0.939,
      -8.984, 1.471,  -9.53,  5.33,   -9.9,   1.909,  -5.277,  8.6};
  const fp32_t fp32_ans_m4[] = {
      9.3515625,   -1.7236328, -2.1601562, 3.9238281,   -2.4179688, -5.6601562,
      -4.234375,   5.1875,     7.0390625,  -7.7304688,  -7.8515625, 3.8964844,
      -4.7421875,  -6.3789062, 1.1777344,  -0.9506836,  3.1621094,  -1.2744141,
      -1.0800781,  -9.125,     -2.125,     -9.40625,    3.5390625,  -4.5742188,
      -7.09375,    6.7695312,  -2.9355469, -5.0078125,  -2.2246094, -5.8671875,
      -0.43774414, -2.6953125, 7.109375,   8.703125,    -9.734375,  -6.5195312,
      -6.8554688,  -3.8183594, 5.90625,    -0.93896484, -8.984375,  1.4707031,
      -9.53125,    5.328125,   -9.8984375, 1.9091797,   -5.2773438, 8.6015625};
  mfloat16m2_t fp16_ts_m2 = mlce16_m2(fp16_src_m2, 16 * sizeof(fp16_t));
  mfloat32m4_t fp32_out_m4 = mfwcvt_fw_f_m(fp16_ts_m2);
  msettype(E32, M4, BA);
  msettileni(16);
  msce32_m(fp32_out_m4, fp32_buffer, 16 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans_m4, fp32_buffer, 3 * 16,
                           "  MFWCVT.FW.F.M  FP16   M2");
  // fp32 -> fp64
  msettype(E32, M2, BA);
  msettilemi(4);
  msettileni(8);
  const fp32_t fp32_src_m2[] = {
      -0.44026503, -4.912233,   -1.6066258, 1.4011068,  8.653488,  -5.8773847,
      -3.8696444,  -9.866086,   5.334842,   -4.3065023, -8.920612, -0.64562273,
      -6.425403,   -0.75137806, -9.276503,  5.4944735,  2.299437,  7.9780664,
      -1.0980426,  -4.5193553,  8.231595,   0.18341534, -7.79046,  7.4195676,
      -8.918168,   0.45485675,  6.8528767,  -5.9107156, 9.068308,  -9.533053,
      -5.522213,   -5.18616};
  const fp64_t fp64_ans_m4[] = {
      -0.44026503, -4.91223288, -1.6066258,  1.40110683,  8.65348816,
      -5.87738466, -3.8696444,  -9.86608601, 5.33484221,  -4.30650234,
      -8.92061234, -0.64562273, -6.42540312, -0.75137806, -9.27650261,
      5.49447346,  2.29943705,  7.97806644,  -1.09804261, -4.5193553,
      8.23159504,  0.18341534,  -7.79046011, 7.41956758,  -8.91816807,
      0.45485675,  6.85287666,  -5.91071558, 9.06830788,  -9.5330534,
      -5.52221298, -5.18616009};
  mfloat32m2_t fp32_ts_m2 = mlce32_m2(fp32_src_m2, 8 * sizeof(fp32_t));
  mfloat64m4_t fp64_out_m4 = mfwcvt_fw_f_m(fp32_ts_m2);
  msettype(E64, M4, BA);
  msettileni(8);
  msce64_m(fp64_out_m4, fp64_buffer, 8 * sizeof(fp64_t));
  EXCEPT_FP64_ARRAY_LAX_EQ(fp64_ans_m4, fp64_buffer, 4 * 8,
                           "  MFWCVT.FW.F.M  FP32   M2");
}

static void test_mfncvt_f_fw_m() {
  // M2
  // fp32 -> fp16
  msettype(E32, M2, BA);
  msettilemi(2);
  msettileni(8);
  const fp32_t fp32_src[] = {
      -3.32705409e+00, -6.55325938e-02, -1.03718274e+00, 4.63159106e+00,
      -7.52493275e+00, 3.61960824e+00,  5.90855889e+00,  -8.62393569e+00,
      -4.41919953e+00, 9.11787050e+00,  8.23710856e+00,  -3.25315766e-03,
      8.02385868e+00,  2.03824825e+00,  -4.05633163e+00, 5.46311582e+00};
  const fp16_t fp16_ans[] = {-3.326e+00, -6.555e-02, -1.037e+00, 4.633e+00,
                             -7.523e+00, 3.619e+00,  5.910e+00,  -8.625e+00,
                             -4.418e+00, 9.117e+00,  8.234e+00,  -3.254e-03,
                             8.023e+00,  2.039e+00,  -4.055e+00, 5.465e+00};
  mfloat32m2_t fp32_ts = mlce32_m2(fp32_src, 4 * sizeof(fp32_t));
  mfloat16m1_t fp16_out = mfncvt_f_fw_m(fp32_ts);
  msettype(E16, M1, BA);
  msettileni(8);
  msce16_m(fp16_out, fp16_buffer, 4 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans, fp16_buffer, 2 * 4,
                           " MFNCVT.F.FW.M  FP32   M2");
  // fp64 -> fp32
  msettype(E64, M2, BA);
  msettilemi(5);
  msettileni(4);
  const fp64_t fp64_src[] = {
      695.67999631,  -836.21908246, 350.85283055,  711.71388925,
      -964.32128336, -952.89518052, 126.70628967,  -633.72946282,
      -286.65343673, -451.77275732, 595.80212497,  -435.7597568,
      259.43780338,  118.49224044,  12.4824893,    -630.55138086,
      -821.96909399, -649.3795461,  -439.12523861, -457.82576525};
  const fp32_t fp32_ans[] = {695.68,     -836.21906, 350.85284,  711.71387,
                             -964.3213,  -952.8952,  126.70629,  -633.7295,
                             -286.65344, -451.77277, 595.8021,   -435.75977,
                             259.4378,   118.49224,  12.48249,   -630.5514,
                             -821.9691,  -649.3795,  -439.12524, -457.82578};
  mfloat64m2_t fp64_ts = mlce64_m2(fp64_src, 4 * sizeof(fp64_t));
  mfloat32m1_t fp32_out = mfncvt_f_fw_m(fp64_ts);
  msettype(E32, M1, BA);
  msettileni(4);
  msce32_m(fp32_out, fp32_buffer, 4 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans, fp32_buffer, 5 * 4,
                           " MFNCVT.F.FW.M  FP64   M2");
  // M4
  // fp32 -> fp16
  msettype(E32, M4, BA);
  msettilemi(2);
  msettileni(16);
  const fp32_t fp32_src_m4[] = {
      -32.285038, -31.340519, 35.528168,  -35.100285, -81.38862,  -99.49909,
      46.335674,  12.841661,  23.827826,  41.770004,  -23.479126, 8.919906,
      -57.9225,   41.3341,    -18.462193, 6.7081347,  -49.739964, -75.816666,
      30.187334,  -83.33598,  63.591846,  43.68498,   22.978003,  51.408714,
      56.42789,   27.540981,  -94.16848,  -89.378555, -61.29343,  22.806185,
      53.10628,   -11.784159};
  const fp16_t fp16_ans_m2[] = {
      -32.28, -31.34, 35.53,  -35.1, -81.4,  -99.5, 46.34,  12.84,
      23.83,  41.78,  -23.48, 8.92,  -57.94, 41.34, -18.47, 6.707,
      -49.75, -75.8,  30.19,  -83.3, 63.6,   43.7,  22.98,  51.4,
      56.44,  27.55,  -94.2,  -89.4, -61.28, 22.81, 53.1,   -11.78};
  mfloat32m4_t fp32_ts_m4 = mlce32_m4(fp32_src_m4, 16 * sizeof(fp32_t));
  mfloat16m2_t fp16_out_m2 = mfncvt_f_fw_m(fp32_ts_m4);
  msettype(E16, M2, BA);
  msettileni(16);
  msce16_m(fp16_out_m2, fp16_buffer, 16 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m2, fp16_buffer, 2 * 16,
                           " MFNCVT.F.FW.M  FP32   M4");
  // fp64 -> fp32
  msettype(E64, M4, BA);
  msettilemi(2);
  msettileni(8);
  const fp64_t fp64_src_m4[] = {
      -44.50876195, 22.13935647,  80.69530406,  -70.36345031,
      24.52066094,  -55.24929672, -71.83476326, -41.39110121,
      80.97670904,  -53.8364604,  -67.99245948, -41.18359309,
      6.07375773,   -44.08449316, -69.41696673, -35.51413727};
  const fp32_t fp32_ans_m2[] = {-44.508762, 22.139357, 80.695305, -70.36345,
                                24.52066,   -55.2493,  -71.83476, -41.3911,
                                80.97671,   -53.83646, -67.99246, -41.183594,
                                6.0737576,  -44.08449, -69.41697, -35.514137};
  mfloat64m4_t fp64_ts_m4 = mlce64_m4(fp64_src_m4, 8 * sizeof(fp64_t));
  mfloat32m2_t fp32_out_m2 = mfncvt_f_fw_m(fp64_ts_m4);
  msettype(E32, M2, BA);
  msettileni(8);
  msce32_m(fp32_out_m2, fp32_buffer, 8 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans_m2, fp32_buffer, 2 * 8,
                           " MFNCVT.F.FW.M  FP64   M4");
}

static void test_mfcvt_x_f_m() {
  // M1
  // fp16 -> int16
  msettype(E16, M1, BA);
  msettilemi(2);
  msettileni(8);
  const fp16_t fp16_src[] = {5.727,  6.98,  0.746, 5.465, 8.69,  6.402,
                             9.26,   1.623, 1.812, 9.35,  4.414, 0.1646,
                             0.6567, 8.875, 2.799, 5.633};
  const int16_t i16_ans[] = {6, 7, 1, 5, 9, 6, 9, 2, 2, 9, 4, 0, 1, 9, 3, 6};
  mfloat16m1_t fp16_ts = mlce16_m1(fp16_src, 8 * sizeof(fp16_t));
  mint16m1_t i16_out = mfcvt_x_f_m(fp16_ts);
  msce16_m(i16_out, i16_buffer, 8 * sizeof(int16_t));
  EXCEPT_I16_ARRAY_EQ(i16_ans, i16_buffer, 16, " MFCVT.X.F.M    FP16   M1");
  // fp32 -> int32
  msettype(E32, M1, BA);
  msettilemi(3);
  msettileni(4);
  const fp32_t fp32_src[] = {9.105877, -7.9911723, 9.192052, 1.872551,
                             6.554558, 3.4383726,  -2.09745, -1.2487175,
                             -7.59491, -9.235795,  3.579713, 8.614335};
  const int32_t i32_ans[] = {9, -8, 9, 2, 7, 3, -2, -1, -8, -9, 4, 9};
  mfloat32m1_t fp32_ts = mlce32_m1(fp32_src, 4 * sizeof(fp32_t));
  mint32m1_t i32_out = mfcvt_x_f_m(fp32_ts);
  msce32_m(i32_out, i32_buffer, 4 * sizeof(int32_t));
  EXCEPT_I32_ARRAY_EQ(i32_ans, i32_buffer, 12, " MFCVT.X.F.M    FP32   M1");
  // fp64 -> int64
  msettype(E64, M1, BA);
  msettilemi(4);
  msettileni(2);
  const fp64_t fp64_src[] = {3.73288207, -5.02838049, -9.68786742,
                             9.57923427, -8.25799651, -3.49967401,
                             -0.1138028, -3.75512359};
  const int64_t i64_ans[] = {4, -5, -10, 10, -8, -3, 0, -4};
  mfloat64m1_t fp64_ts = mlce64_m1(fp64_src, 2 * sizeof(fp64_t));
  mint64m1_t i64_out = mfcvt_x_f_m(fp64_ts);
  msce64_m(i64_out, i64_buffer, 2 * sizeof(int64_t));
  EXCEPT_I64_ARRAY_EQ(i64_ans, i64_buffer, 8, " MFCVT.X.F.M    FP64   M1");
  // M2
  // fp16 -> int16
  msettype(E16, M2, BA);
  msettilemi(3);
  msettileni(16);
  const fp16_t fp16_src_m2[] = {
      -3.6422518,  -7.24436925, -2.21444662, -7.81842753, 8.68579538,
      0.32966046,  9.01327908,  -4.78415107, -5.87018122, -1.18834752,
      6.27096847,  0.95006734,  -5.08741731, -5.04305323, 6.35854883,
      7.47488449,  8.0411787,   -8.59190533, 9.86819094,  2.2198119,
      7.16936067,  3.27809804,  -9.54567369, -8.60629887, 1.63465406,
      -1.8300092,  -1.42652628, 4.31871215,  -3.64277723, 7.07591714,
      -7.07132203, 9.63579325,  2.73483651,  2.51124728,  1.21706678,
      -2.73241288, 5.87539608,  1.46502715,  -3.98377658, -7.62912885,
      -3.99728772, -9.17290163, 2.2990773,   6.70916367,  5.1912698,
      -4.27841459, 1.74489432,  0.65123175};
  const int16_t i16_ans_m2[] = {-4, -7, -2, -8, 9,  0,  9,  -5, -6, -1, 6,   1,
                                -5, -5, 6,  7,  8,  -9, 10, 2,  7,  3,  -10, -9,
                                2,  -2, -1, 4,  -4, 7,  -7, 10, 3,  3,  1,   -3,
                                6,  1,  -4, -8, -4, -9, 2,  7,  5,  -4, 2,   1};
  mfloat16m2_t fp16_ts_m2 = mlce16_m2(fp16_src_m2, 16 * sizeof(fp16_t));
  mint16m2_t i16_out_m2 = mfcvt_x_f_m(fp16_ts_m2);
  msce16_m(i16_out_m2, i16_buffer, 16 * sizeof(int16_t));
  EXCEPT_I16_ARRAY_EQ(i16_ans_m2, i16_buffer, 3 * 16,
                      " MFCVT.X.F.M    FP16   M2");
  // fp32 -> int32
  msettype(E32, M2, BA);
  msettilemi(4);
  msettileni(8);
  const fp32_t fp32_src_m2[] = {
      5.8290434,  -3.9324362, 5.400099,  -6.179675,  2.31005,    -6.1338773,
      -9.185701,  -4.564212,  -9.029782, 6.098467,   6.9230666,  -4.4713526,
      2.5370858,  3.8590615,  1.0354474, 9.273558,   -6.8032513, -5.94375,
      0.28531098, -3.2577834, -6.324995, -3.1981707, -0.6309716, 0.70225817,
      4.761879,   -7.378817,  6.070912,  5.7649155,  8.136628,   -9.43526,
      6.2292295,  -4.7706585};
  const int32_t i32_ans_m2[] = {6,  -4, 5, -6, 2, -6, -9, -5, -9, 6,  7,
                                -4, 3,  4, 1,  9, -7, -6, 0,  -3, -6, -3,
                                -1, 1,  5, -7, 6, 6,  8,  -9, 6,  -5};
  mfloat32m2_t fp32_ts_m2 = mlce32_m2(fp32_src_m2, 8 * sizeof(fp32_t));
  mint32m2_t i32_out_m2 = mfcvt_x_f_m(fp32_ts_m2);
  msce32_m(i32_out_m2, i32_buffer, 8 * sizeof(int32_t));
  EXCEPT_I32_ARRAY_EQ(i32_ans_m2, i32_buffer, 4 * 8,
                      " MFCVT.X.F.M    FP32   M2");
  // fp64 -> int64
  msettype(E64, M2, BA);
  msettilemi(5);
  msettileni(4);
  const fp64_t fp64_src_m2[] = {-2.166e+00, 6.012e+00,  4.121e+00,  4.762e+00,
                                7.266e+00,  7.926e+00,  -5.551e+00, -5.645e+00,
                                -4.977e+00, 9.586e+00,  -7.812e-01, 1.246e-01,
                                -8.562e+00, -7.602e+00, -3.816e+00, -5.168e+00,
                                -6.824e+00, -3.762e+00, -6.001e-03, 5.259e-01};
  const int64_t i64_ans_m2[] = {-2, 6, 4,  5,  7,  8,  -6, -6, -5, 10,
                                -1, 0, -9, -8, -4, -5, -7, -4, 0,  1};
  mfloat64m2_t fp64_ts_m2 = mlce64_m2(fp64_src_m2, 4 * sizeof(fp64_t));
  mint64m2_t i64_out_m2 = mfcvt_x_f_m(fp64_ts_m2);
  msce64_m(i64_out_m2, i64_buffer, 4 * sizeof(int64_t));
  EXCEPT_I64_ARRAY_EQ(i64_ans_m2, i64_buffer, 5 * 4,
                      " MFCVT.X.F.M    FP64   M2");
  // M4
  // fp16 -> int16
  msettype(E16, M4, BA);
  msettilemi(3);
  msettileni(17);
  const fp16_t fp16_src_m4[] = {
      -3.6422518,  -7.24436925, -2.21444662, -7.81842753, 8.68579538,
      0.32966046,  9.01327908,  -4.78415107, -5.87018122, -1.18834752,
      6.27096847,  0.95006734,  -5.08741731, -5.04305323, 6.35854883,
      7.47488449,  8.0411787,   -8.59190533, 9.86819094,  2.2198119,
      7.16936067,  3.27809804,  -9.54567369, -8.60629887, 1.63465406,
      -1.8300092,  -1.42652628, 4.31871215,  -3.64277723, 7.07591714,
      -7.07132203, 9.63579325,  2.73483651,  2.51124728,  1.21706678,
      -2.73241288, 5.87539608,  1.46502715,  -3.98377658, -7.62912885,
      -3.99728772, -9.17290163, 2.2990773,   6.70916367,  5.1912698,
      -4.27841459, 1.74489432,  0.65123175,  -4.27841459, 1.74489432,
      0.65123175};
  const int16_t i16_ans_m4[] = {
      -4, -7, -2, -8, 9,  0,   9,  -5, -6, -1, 6, 1,  -5, -5, 6,  7, 8,
      -9, 10, 2,  7,  3,  -10, -9, 2,  -2, -1, 4, -4, 7,  -7, 10, 3, 3,
      1,  -3, 6,  1,  -4, -8,  -4, -9, 2,  7,  5, -4, 2,  1,  -4, 2, 1};
  mfloat16m4_t fp16_ts_m4 = mlce16_m4(fp16_src_m4, 17 * sizeof(fp16_t));
  mint16m4_t i16_out_m4 = mfcvt_x_f_m(fp16_ts_m4);
  msce16_m(i16_out_m4, i16_buffer, 17 * sizeof(int16_t));
  EXCEPT_I16_ARRAY_EQ(i16_ans_m4, i16_buffer, 3 * 17,
                      " MFCVT.X.F.M    FP16   M4");
  // fp32 -> int32
  msettype(E32, M4, BA);
  msettilemi(4);
  msettileni(9);
  const fp32_t fp32_src_m4[] = {
      5.8290434,  -3.9324362, 5.400099,  -6.179675,  2.31005,    -6.1338773,
      -9.185701,  -4.564212,  -9.029782, 6.098467,   6.9230666,  -4.4713526,
      2.5370858,  3.8590615,  1.0354474, 9.273558,   -6.8032513, -5.94375,
      0.28531098, -3.2577834, -6.324995, -3.1981707, -0.6309716, 0.70225817,
      4.761879,   -7.378817,  6.070912,  5.7649155,  8.136628,   -9.43526,
      6.2292295,  -4.7706585, 8.136628,  -9.43526,   6.2292295,  -4.7706585};
  const int32_t i32_ans_m4[] = {6, -4, 5, -6, 2,  -6, -9, -5, -9, 6,  7,  -4,
                                3, 4,  1, 9,  -7, -6, 0,  -3, -6, -3, -1, 1,
                                5, -7, 6, 6,  8,  -9, 6,  -5, 8,  -9, 6,  -5};
  mfloat32m4_t fp32_ts_m4 = mlce32_m4(fp32_src_m4, 9 * sizeof(fp32_t));
  mint32m4_t i32_out_m4 = mfcvt_x_f_m(fp32_ts_m4);
  msce32_m(i32_out_m4, i32_buffer, 9 * sizeof(int32_t));
  EXCEPT_I32_ARRAY_EQ(i32_ans_m4, i32_buffer, 4 * 9,
                      " MFCVT.X.F.M    FP32   M4");
  // fp64 -> int64
  msettype(E64, M4, BA);
  msettilemi(5);
  msettileni(5);
  const fp64_t fp64_src_m4[] = {
      -2.166e+00, 6.012e+00,  4.121e+00,  4.762e+00,  7.266e+00,
      7.926e+00,  -5.551e+00, -5.645e+00, -4.977e+00, 9.586e+00,
      -7.812e-01, 1.246e-01,  -8.562e+00, -7.602e+00, -3.816e+00,
      -5.168e+00, -6.824e+00, -3.762e+00, -6.001e-03, 5.259e-01,
      -5.168e+00, -6.824e+00, -3.762e+00, -6.001e-03, 5.259e-01};
  const int64_t i64_ans_m4[] = {-2, 6,  4,  5,  7,  8,  -6, -6, -5,
                                10, -1, 0,  -9, -8, -4, -5, -7, -4,
                                0,  1,  -5, -7, -4, 0,  1};
  mfloat64m4_t fp64_ts_m4 = mlce64_m4(fp64_src_m4, 5 * sizeof(fp64_t));
  mint64m4_t i64_out_m4 = mfcvt_x_f_m(fp64_ts_m4);
  msce64_m(i64_out_m4, i64_buffer, 5 * sizeof(int64_t));
  EXCEPT_I64_ARRAY_EQ(i64_ans_m4, i64_buffer, 5 * 5,
                      " MFCVT.X.F.M    FP64   M4");
}

static void test_mfncvt_f_xw_m() {
  // M2
  // int32 -> fp16
  msettype(E32, M2, BA);
  msettilemi(4);
  msettileni(8);
  const int32_t i32_src_m2[] = {7,  6,  0,  -4, 6,  3,   0,  3,  9,  3,  -5,
                                -9, -2, -4, 7,  -6, -4,  -5, 8,  -9, 5,  -7,
                                -8, 4,  -6, 6,  -3, -10, 2,  -5, -9, -10};
  const fp16_t fp16_ans_m1[] = {7.,  6.,  0.,  -4.,  6.,  3.,  0.,  3.,
                                9.,  3.,  -5., -9.,  -2., -4., 7.,  -6.,
                                -4., -5., 8.,  -9.,  5.,  -7., -8., 4.,
                                -6., 6.,  -3., -10., 2.,  -5., -9., -10.};
  mint32m2_t i32_ts_m2 = mlce32_m2(i32_src_m2, 8 * sizeof(int32_t));
  mfloat16m1_t fp16_out = mfncvt_f_xw_m(i32_ts_m2);
  msettype(E16, M1, BA);
  msettileni(8);
  msce16_m(fp16_out, fp16_buffer, 8 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m1, fp16_buffer, 4 * 8,
                           " MFNCVT.F.XW.M  INT32  M2");
  // int64_m2 -> fp32_m1
  msettype(E64, M2, BA);
  msettilemi(5);
  msettileni(4);
  const int64_t i64_src_m2[] = {
      -7782439802280215451, 6764837374347521703,  -6098977860932615759,
      3047226602298798752,  -6174041501067074133, 6999104385339209126,
      4425804176771247192,  8778344137073499821,  -3838792319321202891,
      1816786627480054609,  -2717215748583800478, 5130741845072101140,
      6336120223985055157,  4918384696291882927,  6643671188289623796,
      -5095216170579494803, -1583138797871960697, -4419737992748852531,
      436356942999179309,   8078454749677743122};
  const fp32_t fp32_ans[] = {
      -7782439802280215451., 6764837374347521703.,  -6098977860932615759.,
      3047226602298798752.,  -6174041501067074133., 6999104385339209126.,
      4425804176771247192.,  8778344137073499821.,  -3838792319321202891.,
      1816786627480054609.,  -2717215748583800478., 5130741845072101140.,
      6336120223985055157.,  4918384696291882927.,  6643671188289623796.,
      -5095216170579494803., -1583138797871960697., -4419737992748852531.,
      436356942999179309.,   8078454749677743122.};
  mint64m2_t i64_ts_m2 = mlce64_m2(i64_src_m2, 4 * sizeof(int64_t));
  mfloat32m1_t fp32_out = mfncvt_f_xw_m(i64_ts_m2);
  msettype(E32, M1, BA);
  msettileni(4);
  msce32_m(fp32_out, fp32_buffer, 4 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans, fp32_buffer, 5 * 4,
                           " MFNCVT.F.XW.M  INT64  M2");
  // M4
  // int32_m4 -> fp16_m2
  msettype(E32, M4, BA);
  msettilemi(4);
  msettileni(16);
  const int32_t i32_src_m4[] = {
      205,  257, 624,  929, 470,  121,  -37,  -729, 264,  130,  701, 765, 984,
      -903, -3,  -323, 586, -782, -108, 163,  24,   -861, -644, 512, 818, -215,
      704,  542, 37,   834, -590, -494, -173, -612, 579,  503,  637, 136, 284,
      401,  976, 32,   204, 855,  590,  -294, -82,  330,  -106, 516, -13, -128,
      357,  548, -138, 149, -461, 845,  -648, 211,  -812, -987, 104, -156};
  const fp16_t fp16_ans_m2[] = {
      205.,  257.,  624.,  929.,  470.,  121.,  -37.,  -729., 264.,  130.,
      701.,  765.,  984.,  -903., -3.,   -323., 586.,  -782., -108., 163.,
      24.,   -861., -644., 512.,  818.,  -215., 704.,  542.,  37.,   834.,
      -590., -494., -173., -612., 579.,  503.,  637.,  136.,  284.,  401.,
      976.,  32.,   204.,  855.,  590.,  -294., -82.,  330.,  -106., 516.,
      -13.,  -128., 357.,  548.,  -138., 149.,  -461., 845.,  -648., 211.,
      -812., -987., 104.,  -156.};
  mint32m4_t i32_ts_m4 = mlce32_m4(i32_src_m4, 16 * sizeof(int32_t));
  mfloat16m2_t fp16_out_m2 = mfncvt_f_xw_m(i32_ts_m4);
  msettype(E16, M2, BA);
  msettileni(16);
  msce16_m(fp16_out_m2, fp16_buffer, 16 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m2, fp16_buffer, 4 * 16,
                           " MFNCVT.F.XW.M  INT32  M4");
  // int64_m4 -> fp32_m2
  msettype(E64, M4, BA);
  msettilemi(5);
  msettileni(8);
  const int64_t i64_src_m4[] = {57, -42, -58, -30, -58, 51,  25,  -75, 31, 28,
                                93, -19, -23, 60,  -76, -97, 97,  -14, 23, 86,
                                8,  4,   -41, -72, 66,  -38, -49, 22,  50, -41,
                                30, -30, -93, 87,  77,  -9,  13,  92,  14, 98};
  const fp32_t fp32_ans_m2[] = {57.,  -42., -58., -30., -58., 51.,  25.,  -75.,
                                31.,  28.,  93.,  -19., -23., 60.,  -76., -97.,
                                97.,  -14., 23.,  86.,  8.,   4.,   -41., -72.,
                                66.,  -38., -49., 22.,  50.,  -41., 30.,  -30.,
                                -93., 87.,  77.,  -9.,  13.,  92.,  14.,  98.};
  mint64m4_t i64_ts_m4 = mlce64_m4(i64_src_m4, 8 * sizeof(int64_t));
  mfloat32m2_t fp32_out_m2 = mfncvt_f_xw_m(i64_ts_m4);
  msettype(E32, M2, BA);
  msettileni(8);
  msce32_m(fp32_out_m2, fp32_buffer, 8 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans_m2, fp32_buffer, 5 * 8,
                           " MFNCVT.F.XW.M  INT64  M4");
}

static void test_mfncvt_f_xq_m() {
  // M4
  // int64_m4 -> fp16_m1
  msettype(E64, M4, BA);
  msettilemi(5);
  msettileni(8);
  const int64_t i64_src_m4[] = {-84, -28, -47, -83, 82, 1,   41,  94,  -15, -21,
                                42,  53,  67,  22,  7,  24,  -81, 60,  57,  70,
                                -54, 86,  54,  21,  25, -89, 88,  -66, 23,  94,
                                -90, 2,   -89, -16, 39, 1,   62,  12,  -98, 95};
  const fp16_t fp16_ans_m1[] = {-84., -28., -47., -83., 82.,  1.,  41.,  94.,
                                -15., -21., 42.,  53.,  67.,  22., 7.,   24.,
                                -81., 60.,  57.,  70.,  -54., 86., 54.,  21.,
                                25.,  -89., 88.,  -66., 23.,  94., -90., 2.,
                                -89., -16., 39.,  1.,   62.,  12., -98., 95.};
  mint64m4_t i64_ts_m4 = mlce64_m4(i64_src_m4, 8 * sizeof(int64_t));
  mfloat16m1_t fp16_out_m1 = mfncvt_f_xq_m(i64_ts_m4);
  msettype(E16, M1, BA);
  msettileni(8);
  msce16_m(fp16_out_m1, fp16_buffer, 8 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m1, fp16_buffer, 5 * 8,
                           " MFNCVT.F.XQ.M  INT64  M4");
}

static void test_mfcvt_f_x_m() {
  // M1
  // fp16 -> int16
  msettype(E16, M1, BA);
  msettilemi(2);
  msettileni(8);
  const int16_t i16_src[] = {6, 7, 1, 5, 9, 6, 9, 2, 2, 9, 4, 0, 1, 9, 3, 6};
  const fp16_t fp16_ans[] = {6., 7., 1., 5., 9., 6., 9., 2.,
                             2., 9., 4., 0., 1., 9., 3., 6.};
  mint16m1_t i16_ts = mlce16_m1(i16_src, 8 * sizeof(int16_t));
  mfloat16m1_t fp16_out = mfcvt_f_x_m(i16_ts);
  msce16_m(fp16_out, fp16_buffer, 8 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans, fp16_buffer, 16,
                           " MFCVT.F.X.M    FP16   M1");
  // fp32 -> int32
  msettype(E32, M1, BA);
  msettilemi(3);
  msettileni(4);
  const int32_t i32_src[] = {-1795842372, -1213855484, -1629579745, 2059410011,
                             1523184726,  476842412,   -1400484987, 1256326186,
                             1603776008,  953896580,   -1749540049, 25332806};
  const fp32_t fp32_ans[] = {-1795842372., -1213855484., -1629579745.,
                             2059410011.,  1523184726.,  476842412.,
                             -1400484987., 1256326186.,  1603776008.,
                             953896580.,   -1749540049., 25332806.};
  mint32m1_t i32_ts = mlce32_m1(i32_src, 4 * sizeof(int32_t));
  mfloat32m1_t fp32_out = mfcvt_f_x_m(i32_ts);
  msce32_m(fp32_out, fp32_buffer, 4 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans, fp32_buffer, 12,
                           " MFCVT.F.X.M    FP32   M1");
  // fp64 -> int64
  msettype(E64, M1, BA);
  msettilemi(4);
  msettileni(2);
  const int64_t i64_src[] = {-388819934706429, 865166493733528, 396968368841636,
                             -987282128885980, 208754132773042, 348049722557089,
                             49885910795216,   -181009295873102};
  const fp64_t fp64_ans[] = {
      -388819934706429., 865166493733528., 396968368841636., -987282128885980.,
      208754132773042.,  348049722557089., 49885910795216.,  -181009295873102.};
  mint64m1_t i64_ts = mlce64_m1(i64_src, 2 * sizeof(int64_t));
  mfloat64m1_t fp64_out = mfcvt_f_x_m(i64_ts);
  msce64_m(fp64_out, fp64_buffer, 2 * sizeof(fp64_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp64_ans, fp64_buffer, 8,
                           " MFCVT.F.X.M    FP64   M1");
  // M2
  // fp16 -> int16
  msettype(E16, M2, BA);
  msettilemi(3);
  msettileni(16);
  const int16_t i16_src_m2[] = {
      32088,  -3418,  5810,  28812,  23276,  8543,   -17547, 26133,
      19692,  -10270, 6662,  -644,   29331,  -17666, -17302, 20355,
      -12353, -3022,  -3141, -17876, -15784, -10639, -31395, -13267,
      -20863, -24698, 20783, 24811,  -28968, 27667,  -1506,  -31763,
      -26214, 15763,  30566, 27290,  28874,  15353,  -29159, -26131,
      -28888, -1280,  2274,  -22754, -15603, 10200,  -17227, -18874};
  const fp16_t fp16_ans_m2[] = {
      32096.,  -3418.,  5808.,  28816.,  23280.,  8544.,   -17552., 26128.,
      19696.,  -10272., 6664.,  -644.,   29328.,  -17664., -17296., 20352.,
      -12352., -3022.,  -3140., -17872., -15784., -10640., -31392., -13264.,
      -20864., -24704., 20784., 24816.,  -28960., 27664.,  -1506.,  -31760.,
      -26208., 15760.,  30560., 27296.,  28880.,  15352.,  -29152., -26128.,
      -28896., -1280.,  2274.,  -22752., -15600., 10200.,  -17232., -18880.};
  mint16m2_t i16_ts_m2 = mlce16_m2(i16_src_m2, 16 * sizeof(int16_t));
  mfloat16m2_t fp16_out_m2 = mfcvt_f_x_m(i16_ts_m2);
  msce16_m(fp16_out_m2, fp16_buffer, 16 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m2, fp16_buffer, 3 * 16,
                           " MFCVT.F.X.M    FP16   M2");
  // fp32 -> int32
  msettype(E32, M2, BA);
  msettilemi(4);
  msettileni(8);
  const int32_t i32_src_m2[] = {
      95954520,    790433789,   1560951976, 837811700,   1662993797,
      -680741913,  -941409779,  -552980334, -1523204112, -1541537898,
      629137501,   -1273854146, 1112482344, 1242404432,  -1517774104,
      1708168880,  55463776,    387101578,  -589054172,  1790791714,
      1709411640,  1879017375,  1980126577, 1569288921,  -1232383094,
      -2103837333, -1426536741, 597501112,  1556096566,  -1051728978,
      705715758,   9826327};
  const fp32_t fp32_ans_m2[] = {
      95954520,    790433789,   1560951976, 837811700,   1662993797,
      -680741913,  -941409779,  -552980334, -1523204112, -1541537898,
      629137501,   -1273854146, 1112482344, 1242404432,  -1517774104,
      1708168880,  55463776,    387101578,  -589054172,  1790791714,
      1709411640,  1879017375,  1980126577, 1569288921,  -1232383094,
      -2103837333, -1426536741, 597501112,  1556096566,  -1051728978,
      705715758,   9826327};
  mint32m2_t i32_ts_m2 = mlce32_m2(i32_src_m2, 8 * sizeof(int32_t));
  mfloat32m2_t fp32_out_m2 = mfcvt_f_x_m(i32_ts_m2);
  msce32_m(fp32_out_m2, fp32_buffer, 8 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans_m2, fp32_buffer, 4 * 8,
                           " MFCVT.F.X.M    FP32   M2");
  // fp64 -> int64
  msettype(E64, M2, BA);
  msettilemi(5);
  msettileni(4);
  const int64_t i64_src_m2[] = {
      3603703319676409427,  -7650184526002243955, -5781352017999813957,
      -4236533746270993174, -4632759617136636474, -3562409828888497598,
      737687118930508522,   -8121225247073114668, 4057095462245096609,
      530067670666570037,   -4685589643318408781, -6978102897766376982,
      -4416633820972856048, -5713770708324304558, -8116248858081355686,
      4161420361700563235,  7363784519112602511,  -3373463674622629308,
      6678498076521692135,  1311810860786012176};
  const fp64_t fp64_ans_m2[] = {
      3603703319676409427,  -7650184526002243955, -5781352017999813957,
      -4236533746270993174, -4632759617136636474, -3562409828888497598,
      737687118930508522,   -8121225247073114668, 4057095462245096609,
      530067670666570037,   -4685589643318408781, -6978102897766376982,
      -4416633820972856048, -5713770708324304558, -8116248858081355686,
      4161420361700563235,  7363784519112602511,  -3373463674622629308,
      6678498076521692135,  1311810860786012176};
  mint64m2_t i64_ts_m2 = mlce64_m2(i64_src_m2, 4 * sizeof(int64_t));
  mfloat64m2_t fp64_out_m2 = mfcvt_f_x_m(i64_ts_m2);
  msce64_m(fp64_out_m2, fp64_buffer, 4 * sizeof(fp64_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp64_ans_m2, fp64_buffer, 5 * 4,
                           " MFCVT.F.X.M    FP64   M2");
  // M4
  // fp16 -> int16
  msettype(E16, M4, BA);
  msettilemi(3);
  msettileni(17);
  const int16_t i16_src_m4[] = {
      -454,   -31076, -30924, 7306,   -10869, 21671,  -18167, 25050, 10132,
      -27193, 28253,  -6176,  -11574, -21425, 32568,  -15510, -4079, -19057,
      24565,  9919,   22549,  -2165,  7428,   -17151, -25812, 4341,  -10201,
      -18774, 21517,  -23134, 26468,  4781,   -2773,  5878,   -2546, 27845,
      -12054, 3570,   1905,   9744,   2462,   12338,  -1749,  3681,  6349,
      -27427, -15889, 4506,   30945,  -4495,  10811};
  const fp16_t fp16_ans_m4[] = {
      -454.,   -31072., -30928., 7304.,   -10872., 21664.,  -18160., 25056.,
      10128.,  -27200., 28256.,  -6176.,  -11576., -21424., 32576.,  -15512.,
      -4080.,  -19056., 24560.,  9920.,   22544.,  -2164.,  7428.,   -17152.,
      -25808., 4340.,   -10200., -18768., 21520.,  -23136., 26464.,  4780.,
      -2772.,  5880.,   -2546.,  27840.,  -12056., 3570.,   1905.,   9744.,
      2462.,   12336.,  -1749.,  3680.,   6348.,   -27424., -15888., 4504.,
      30944.,  -4496.,  10808.};
  mint16m4_t i16_ts_m4 = mlce16_m4(i16_src_m4, 17 * sizeof(int16_t));
  mfloat16m4_t fp16_out_m4 = mfcvt_f_x_m(i16_ts_m4);
  msce16_m(fp16_out_m4, fp16_buffer, 17 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m4, fp16_buffer, 3 * 17,
                           " MFCVT.F.X.M    FP16   M4");
  // fp32 -> int32
  msettype(E32, M4, BA);
  msettilemi(4);
  msettileni(9);
  const int32_t i32_src_m4[] = {
      25649343,    1482297741,  -1978815722, -798585286,  -1437430897,
      439170658,   -1100526543, 941112955,   -1863663166, 442154238,
      -505479756,  -1380281967, 1592492930,  -812579263,  -1259720292,
      -1300639367, 1589741319,  -1046529892, 45359625,    -153806718,
      249441823,   -1045312659, -700970605,  1611568630,  -475335266,
      753122134,   -1078406244, 2031102837,  229308032,   1203423150,
      1192238604,  219020883,   -1842439106, -1683664384, 1576689610,
      -321909856};
  const fp32_t fp32_ans_m4[] = {
      25649343,    1482297741,  -1978815722, -798585286,  -1437430897,
      439170658,   -1100526543, 941112955,   -1863663166, 442154238,
      -505479756,  -1380281967, 1592492930,  -812579263,  -1259720292,
      -1300639367, 1589741319,  -1046529892, 45359625,    -153806718,
      249441823,   -1045312659, -700970605,  1611568630,  -475335266,
      753122134,   -1078406244, 2031102837,  229308032,   1203423150,
      1192238604,  219020883,   -1842439106, -1683664384, 1576689610,
      -321909856};
  mint32m4_t i32_ts_m4 = mlce32_m4(i32_src_m4, 9 * sizeof(int32_t));
  mfloat32m4_t fp32_out_m4 = mfcvt_f_x_m(i32_ts_m4);
  msce32_m(fp32_out_m4, fp32_buffer, 9 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans_m4, fp32_buffer, 4 * 9,
                           " MFCVT.F.X.M    FP32   M4");
  // fp64 -> int64
  msettype(E64, M4, BA);
  msettilemi(5);
  msettileni(5);
  const int64_t i64_src_m4[] = {
      5257070156838777019,  1905696237146984162,  -4255164303002367634,
      3338167663849222796,  -5311183648725001498, 2704520498437851054,
      8229816981828514786,  6232661663780583103,  4803070896716133942,
      8170140845204839888,  -7936811629977115263, 3532412177257931349,
      -3133436619624977697, -2768598511616768460, 2769958414709506927,
      3197410208596968159,  9122776771956752293,  7272691304005009061,
      -5936446618209946968, 4340274043100878987,  -2131152216193101726,
      -8775531606750652202, 4331692942963887737,  417245553198827659,
      -3608734372317745987};
  const fp64_t fp64_ans_m4[] = {
      5257070156838777019,  1905696237146984162,  -4255164303002367634,
      3338167663849222796,  -5311183648725001498, 2704520498437851054,
      8229816981828514786,  6232661663780583103,  4803070896716133942,
      8170140845204839888,  -7936811629977115263, 3532412177257931349,
      -3133436619624977697, -2768598511616768460, 2769958414709506927,
      3197410208596968159,  9122776771956752293,  7272691304005009061,
      -5936446618209946968, 4340274043100878987,  -2131152216193101726,
      -8775531606750652202, 4331692942963887737,  417245553198827659,
      -3608734372317745987};
  mint64m4_t i64_ts_m4 = mlce64_m4(i64_src_m4, 5 * sizeof(int64_t));
  mfloat64m4_t fp64_out_m4 = mfcvt_f_x_m(i64_ts_m4);
  msce64_m(fp64_out_m4, fp64_buffer, 5 * sizeof(fp64_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp64_ans_m4, fp64_buffer, 5 * 5,
                           " MFCVT.F.X.M    FP64   M4");
}

static void test_mfwcvt_fw_x_m() {
  // M1
  // int8 -> fp16
  msettype(E8, M1, BA);
  msettilemi(2);
  msettileni(16);
  const int8_t i8_src[] = {72,  29,   -121, -45, 120, 108, 20,   -81,
                           40,  6,    -65,  46,  0,   -52, 38,   -117,
                           12,  -105, 42,   88,  106, 22,  40,   -81,
                           -32, 50,   90,   56,  115, 61,  -125, 5};
  const fp16_t fp16_ans[] = {72.,  29.,   -121., -45., 120., 108., 20.,   -81.,
                             40.,  6.,    -65.,  46.,  0.,   -52., 38.,   -117.,
                             12.,  -105., 42.,   88.,  106., 22.,  40.,   -81.,
                             -32., 50.,   90.,   56.,  115., 61.,  -125., 5.};
  mint8m1_t i8_ts = mlce8_m1(i8_src, 16 * sizeof(int8_t));
  mfloat16m2_t fp16_out = mfwcvt_fw_x_m(i8_ts);
  msettype(E16, M2, BA);
  msettileni(16);
  msce16_m(fp16_out, fp16_buffer, 16 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_EQ(fp16_ans, fp16_buffer, 2 * 16,
                       " MFWCVT.FW.X.M  INT8   M1");
  // int16 -> fp32
  msettype(E16, M1, BA);
  msettilemi(3);
  msettileni(8);
  const int16_t i16_src[] = {-26976, -23192, -25254, 16379,  -8263, -27110,
                             -20784, 4036,   -5876,  -21704, -6108, -11495,
                             10508,  31078,  -24656, 18085,  23429, -1815,
                             -4573,  -4361,  31342,  5635,   32043, 15543};
  const fp32_t fp32_ans[] = {
      -26976., -23192., -25254., 16379.,  -8263., -27110., -20784., 4036.,
      -5876.,  -21704., -6108.,  -11495., 10508., 31078.,  -24656., 18085.,
      23429.,  -1815.,  -4573.,  -4361.,  31342., 5635.,   32043.,  15543.};
  mint16m1_t i16_ts = mlce16_m1(i16_src, 8 * sizeof(int16_t));
  mfloat32m2_t fp32_out = mfwcvt_fw_x_m(i16_ts);
  msettype(E32, M2, BA);
  msettileni(8);
  msce32_m(fp32_out, fp32_buffer, 8 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_EQ(fp32_ans, fp32_buffer, 3 * 8,
                       " MFWCVT.FW.X.M  INT16  M1");
  // int32 -> fp64
  msettype(E32, M1, BA);
  msettilemi(4);
  msettileni(4);
  const int32_t i32_src[] = {799744513,  1907044444, -951902568,  337868073,
                             461512219,  -108730473, 1222230041,  1357598688,
                             -304100272, 996970028,  461978749,   1668676275,
                             1480562128, 1310005250, -1081898731, 86161545};
  const fp64_t fp64_ans[] = {
      799744513.,  1907044444., -951902568.,  337868073.,
      461512219.,  -108730473., 1222230041.,  1357598688.,
      -304100272., 996970028.,  461978749.,   1668676275.,
      1480562128., 1310005250., -1081898731., 86161545.};
  mint32m1_t i32_ts = mlce32_m1(i32_src, 4 * sizeof(int32_t));
  mfloat64m2_t fp64_out = mfwcvt_fw_x_m(i32_ts);
  msettype(E64, M2, BA);
  msettileni(4);
  msce64_m(fp64_out, fp64_buffer, 4 * sizeof(fp64_t));
  EXCEPT_FP64_ARRAY_EQ(fp64_ans, fp64_buffer, 4 * 4,
                       " MFWCVT.FW.X.M  INT32  M1");
  // M2
  // int8 -> fp16
  msettype(E8, M2, BA);
  msettilemi(2);
  msettileni(32);
  const int8_t i8_src_m2[] = {
      -68, -45, 80,   72,   -49, -114, -21, -111, 79,  -38, -112, -79,  20,
      -71, -30, 34,   33,   56,  -104, 79,  68,   104, 115, 48,   72,   49,
      14,  45,  57,   -73,  106, 72,   -48, -46,  26,  93,  -102, 23,   32,
      84,  54,  -119, -125, -19, -36,  -15, -123, 115, 57,  43,   -124, -26,
      -67, 59,  -24,  -39,  18,  39,   42,  -43,  76,  -1,  118,  34};
  const fp16_t fp16_ans_m4[] = {
      -68., -45., 80.,   72.,   -49., -114., -21.,  -111., 79.,   -38.,  -112.,
      -79., 20.,  -71.,  -30.,  34.,  33.,   56.,   -104., 79.,   68.,   104.,
      115., 48.,  72.,   49.,   14.,  45.,   57.,   -73.,  106.,  72.,   -48.,
      -46., 26.,  93.,   -102., 23.,  32.,   84.,   54.,   -119., -125., -19.,
      -36., -15., -123., 115.,  57.,  43.,   -124., -26.,  -67.,  59.,   -24.,
      -39., 18.,  39.,   42.,   -43., 76.,   -1.,   118.,  34.};
  mint8m2_t i8_ts_m2 = mlce8_m2(i8_src_m2, 32 * sizeof(int8_t));
  mfloat16m4_t fp16_out_m4 = mfwcvt_fw_x_m(i8_ts_m2);
  msettype(E16, M4, BA);
  msettileni(32);
  msce16_m(fp16_out_m4, fp16_buffer, 32 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_EQ(fp16_ans_m4, fp16_buffer, 2 * 32,
                       " MFWCVT.FW.X.M  INT8   M2");
  // int16 -> fp32
  msettype(E16, M2, BA);
  msettilemi(3);
  msettileni(8);
  const int16_t i16_src_m2[] = {
      -27547, -13342, 586,    -19691, -29607, 6227,   -10013, 31632,
      7160,   -31870, -13985, 5841,   -7237,  -10707, 9267,   17457,
      -715,   3451,   -31063, 8719,   18784,  20607,  23496,  23622,
      -21011, 12317,  22182,  -12454, -13579, -18293, -20797, 8258,
      23001,  11123,  19831,  31325,  -20573, -11905, -22961, 12023,
      20919,  -23046, -29626, 22323,  14130,  -6594,  -17495, 18242};
  const fp32_t fp32_ans_m4[] = {
      -27547., -13342., 586.,    -19691., -29607., 6227.,   -10013., 31632.,
      7160.,   -31870., -13985., 5841.,   -7237.,  -10707., 9267.,   17457.,
      -715.,   3451.,   -31063., 8719.,   18784.,  20607.,  23496.,  23622.,
      -21011., 12317.,  22182.,  -12454., -13579., -18293., -20797., 8258.,
      23001.,  11123.,  19831.,  31325.,  -20573., -11905., -22961., 12023.,
      20919.,  -23046., -29626., 22323.,  14130.,  -6594.,  -17495., 18242.};
  mint16m2_t i16_ts_m2 = mlce16_m2(i16_src_m2, 16 * sizeof(int16_t));
  mfloat32m4_t fp32_out_m4 = mfwcvt_fw_x_m(i16_ts_m2);
  msettype(E32, M4, BA);
  msettileni(4);
  msce32_m(fp32_out_m4, fp32_buffer, 16 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_EQ(fp32_ans_m4, fp32_buffer, 3 * 16,
                       " MFWCVT.FW.X.M  INT16  M2");
  // int32 -> fp64
  msettype(E32, M2, BA);
  msettilemi(4);
  msettileni(8);
  const int32_t i32_src_m2[] = {
      -416004282,  -96935118,   763844968,   1216252139, -677124980,
      1079264929,  821178717,   1709983285,  -362649211, 658188539,
      -1132580514, -377489399,  -826233041,  1732185439, -658423384,
      1059702102,  -2134132718, 867724222,   -558497496, -1233677188,
      -658882510,  -1244279578, 436862408,   -338248532, 2105357436,
      -1723302867, 69830657,    -1845561904, 1531743658, -74406382,
      -1366588732, 1582803570};
  const fp64_t fp64_ans_m4[] = {
      -416004282.,  -96935118.,   763844968.,   1216252139., -677124980.,
      1079264929.,  821178717.,   1709983285.,  -362649211., 658188539.,
      -1132580514., -377489399.,  -826233041.,  1732185439., -658423384.,
      1059702102.,  -2134132718., 867724222.,   -558497496., -1233677188.,
      -658882510.,  -1244279578., 436862408.,   -338248532., 2105357436.,
      -1723302867., 69830657.,    -1845561904., 1531743658., -74406382.,
      -1366588732., 1582803570.};
  mint32m2_t i32_ts_m2 = mlce32_m2(i32_src_m2, 8 * sizeof(int32_t));
  mfloat64m4_t fp64_out_m4 = mfwcvt_fw_x_m(i32_ts_m2);
  msettype(E64, M4, BA);
  msettileni(8);
  msce64_m(fp64_out_m4, fp64_buffer, 8 * sizeof(fp64_t));
  EXCEPT_FP64_ARRAY_EQ(fp64_ans_m4, fp64_buffer, 4 * 8,
                       " MFWCVT.FW.X.M  INT32  M2");
}

static void test_mfcvt_fw_xw_m() {
  // M2
  // int16  -> fp16
  msettype(E16, M2, BA);
  msettilemi(3);
  msettileni(16);
  const int16_t i16_src_m2[] = {
      -81, 100, 99,  -71, 45,   90,  -47, -43, 82,  123, -101, 108,
      119, 110, 91,  -33, -66,  -20, 98,  90,  73,  80,  -28,  -12,
      22,  -54, 81,  -20, -116, 102, 71,  17,  21,  -97, 122,  77,
      -77, -37, -38, -22, -89,  -85, -36, -55, -43, 55,  29,   -99};
  const fp16_t fp16_ans_m2[] = {
      -81., 100., 99.,  -71., 45.,   90.,  -47., -43., 82.,  123., -101., 108.,
      119., 110., 91.,  -33., -66.,  -20., 98.,  90.,  73.,  80.,  -28.,  -12.,
      22.,  -54., 81.,  -20., -116., 102., 71.,  17.,  21.,  -97., 122.,  77.,
      -77., -37., -38., -22., -89.,  -85., -36., -55., -43., 55.,  29.,   -99.};
  mint16m2_t i16_ts_m2 = mlce16_m2(i16_src_m2, 16 * sizeof(int16_t));
  mfloat16m2_t fp16_out_m2 = mfcvt_fw_xw_m(i16_ts_m2);
  msce16_m(fp16_out_m2, fp16_buffer, 16 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m2, fp16_buffer, 3 * 16,
                           " MFCVT.FW.XW.M  INT16  M2");
  // int32 -> fp32
  msettype(E32, M2, BA);
  msettilemi(4);
  msettileni(8);
  const int32_t i32_src_m2[] = {
      -2038126076, -576978509,  1104806533,  -2137591331, 454665984,
      1154747808,  657960808,   -1423493270, 1896734729,  1788346155,
      1091836455,  -1893507863, -1303564554, -620239398,  -1389846382,
      1075918112,  1351596838,  -288034105,  1325560449,  95458852,
      2023248881,  -881000296,  -85235135,   -334558096,  -983466313,
      656728370,   -174443,     573202985,   -1265610769, 143511571,
      -1016668200, -49647367};
  const fp32_t fp32_ans_m2[] = {
      -2038126076, -576978509,  1104806533,  -2137591331, 454665984,
      1154747808,  657960808,   -1423493270, 1896734729,  1788346155,
      1091836455,  -1893507863, -1303564554, -620239398,  -1389846382,
      1075918112,  1351596838,  -288034105,  1325560449,  95458852,
      2023248881,  -881000296,  -85235135,   -334558096,  -983466313,
      656728370,   -174443,     573202985,   -1265610769, 143511571,
      -1016668200, -49647367};
  mint32m2_t i32_ts_m2 = mlce32_m2(i32_src_m2, 8 * sizeof(int32_t));
  mfloat32m2_t fp32_out_m2 = mfcvt_fw_xw_m(i32_ts_m2);
  msce32_m(fp32_out_m2, fp32_buffer, 8 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans_m2, fp32_buffer, 4 * 8,
                           " MFCVT.FW.XW.M  INT32  M2");
  // int64 -> fp64
  msettype(E64, M2, BA);
  msettilemi(5);
  msettileni(4);
  const int64_t i64_src_m2[] = {
      7578595529297785344,  4690170928382183474,  -3674989166099899864,
      5570962713041314097,  6215124869910122073,  -9212119968325282607,
      -2300122775693346965, 3375635824900964817,  -6103713071953941794,
      4092683063355487948,  1975380021065230905,  -9201231218327440238,
      271917958738173568,   -7125698102284044753, 8401591638058179370,
      3470264504450336030,  -5034948062527068124, 4908042967759652494,
      -1464088548060537862, 3210168751820524700};
  const fp64_t fp64_ans_m2[] = {
      7578595529297785344,  4690170928382183474,  -3674989166099899864,
      5570962713041314097,  6215124869910122073,  -9212119968325282607,
      -2300122775693346965, 3375635824900964817,  -6103713071953941794,
      4092683063355487948,  1975380021065230905,  -9201231218327440238,
      271917958738173568,   -7125698102284044753, 8401591638058179370,
      3470264504450336030,  -5034948062527068124, 4908042967759652494,
      -1464088548060537862, 3210168751820524700};
  mint64m2_t i64_ts_m2 = mlce64_m2(i64_src_m2, 4 * sizeof(int64_t));
  mfloat64m2_t fp64_out_m2 = mfcvt_fw_xw_m(i64_ts_m2);
  msce64_m(fp64_out_m2, fp64_buffer, 4 * sizeof(fp64_t));
  EXCEPT_FP64_ARRAY_LAX_EQ(fp64_ans_m2, fp64_buffer, 5 * 4,
                           " MFCVT.FW.XW.M  INT64  M2");
  // M4
  // int16  -> fp16
  msettype(E16, M4, BA);
  msettilemi(3);
  msettileni(17);
  const int16_t i16_src_m4[] = {
      42,  45,   43,  -66, 96,  109, 35,  -74,  -81, 72, 70,  -8, -20,
      -28, 23,   -81, 9,   86,  -98, -66, 99,   -53, -9, -33, 29, -22,
      -13, 75,   70,  35,  69,  116, -45, -123, 123, 78, 122, 83, 45,
      92,  -104, 84,  -87, -61, -89, 19,  -7,   118, -8, 90,  75};
  const fp16_t fp16_ans_m4[] = {
      42,  45,   43,  -66, 96,  109, 35,  -74,  -81, 72, 70,  -8, -20,
      -28, 23,   -81, 9,   86,  -98, -66, 99,   -53, -9, -33, 29, -22,
      -13, 75,   70,  35,  69,  116, -45, -123, 123, 78, 122, 83, 45,
      92,  -104, 84,  -87, -61, -89, 19,  -7,   118, -8, 90,  75};
  mint16m4_t i16_ts_m4 = mlce16_m4(i16_src_m4, 17 * sizeof(int16_t));
  mfloat16m4_t fp16_out_m4 = mfcvt_fw_xw_m(i16_ts_m4);
  msce16_m(fp16_out_m4, fp16_buffer, 17 * sizeof(fp16_t));
  EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m4, fp16_buffer, 3 * 17,
                           " MFCVT.FW.XW.M  INT16  M4");
  // int32 -> fp32
  msettype(E32, M4, BA);
  msettilemi(4);
  msettileni(16);
  const int32_t i32_src_m4[] = {
      531,  971,  -75,  2,   -713, -877, 820,  66,   -805, -121, -568,
      87,   721,  239,  -55, 463,  937,  -460, 128,  -481, -463, -593,
      -810, -461, 742,  513, 661,  379,  643,  424,  -753, 104,  -863,
      -88,  -105, -407, 965, 665,  -339, -338, -426, -623, -953, -118,
      933,  -528, -148, -47, -212, -684, 885,  -404, -449, -787, 307,
      -803, 373,  920,  298, -283, -679, 626,  803,  745};
  const fp32_t fp32_ans_m4[] = {
      531.,  971.,  -75.,  2.,    -713., -877., 820.,  66.,   -805., -121.,
      -568., 87.,   721.,  239.,  -55.,  463.,  937.,  -460., 128.,  -481.,
      -463., -593., -810., -461., 742.,  513.,  661.,  379.,  643.,  424.,
      -753., 104.,  -863., -88.,  -105., -407., 965.,  665.,  -339., -338.,
      -426., -623., -953., -118., 933.,  -528., -148., -47.,  -212., -684.,
      885.,  -404., -449., -787., 307.,  -803., 373.,  920.,  298.,  -283.,
      -679., 626.,  803.,  745.};
  mint32m4_t i32_ts_m4 = mlce32_m4(i32_src_m4, 16 * sizeof(int32_t));
  mfloat32m4_t fp32_out_m4 = mfcvt_fw_xw_m(i32_ts_m4);
  msce32_m(fp32_out_m4, fp32_buffer, 16 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans_m4, fp32_buffer, 4 * 16,
                           " MFCVT.FW.XW.M  INT32  M4");
  // int64 -> fp64
  msettype(E64, M4, BA);
  msettilemi(5);
  msettileni(8);
  const int64_t i64_src_m4[] = {
      5766,  9422,  3939,  -1117, 4453,  3889,  -1240, 5393,  -7437, -7044,
      -7444, -6149, -7356, 9599,  -7266, -8982, 9968,  9923,  -946,  6626,
      -2349, 6400,  -3646, -9806, 199,   1563,  6609,  -8532, -1074, 1088,
      5694,  2989,  -7068, 6151,  -5394, -9606, 7015,  8742,  -5286, -3832};
  const fp64_t fp64_ans_m4[] = {
      5766.,  9422.,  3939.,  -1117., 4453.,  3889., -1240., 5393.,
      -7437., -7044., -7444., -6149., -7356., 9599., -7266., -8982.,
      9968.,  9923.,  -946.,  6626.,  -2349., 6400., -3646., -9806.,
      199.,   1563.,  6609.,  -8532., -1074., 1088., 5694.,  2989.,
      -7068., 6151.,  -5394., -9606., 7015.,  8742., -5286., -3832.};
  mint64m4_t i64_ts_m4 = mlce64_m4(i64_src_m4, 8 * sizeof(int64_t));
  mfloat64m4_t fp64_out_m4 = mfcvt_fw_xw_m(i64_ts_m4);
  msce64_m(fp64_out_m4, fp64_buffer, 8 * sizeof(fp64_t));
  EXCEPT_FP64_ARRAY_LAX_EQ(fp64_ans_m4, fp64_buffer, 5 * 8,
                           " MFCVT.FW.XW.M  INT64  M4");
}

static void test_mfwcvt_xw_f_m() {
  // M1
  // fp16 -> int32
  msettype(E16, M1, BA);
  msettilemi(3);
  msettileni(8);
  const fp16_t fp16_src[] = {2.863,   -9.734, -3.035, -9.49, -4.81,  -0.815,
                             -9.51,   1.8125, 9.39,   8.89,  -3.121, 3.094,
                             -0.5415, 4.566,  -7.82,  3.037, 2.914,  1.028,
                             -6.5,    -9.11,  -1.999, 4.664, 1.361,  0.5195};
  const int32_t i32_ans_m2[] = {3,  -10, -3, -9, -5, -1, -10, 2,  9,  9, -3, 3,
                                -1, 5,   -8, 3,  3,  1,  -6,  -9, -2, 5, 1,  1};
  mfloat16m1_t fp16_ts = mlce16_m1(fp16_src, 8 * sizeof(fp16_t));
  mint32m2_t i32_out_m2 = mfwcvt_xw_f_m(fp16_ts);
  msettype(E32, M2, BA);
  msettileni(8);
  msce32_m(i32_out_m2, i32_buffer, 8 * sizeof(int32_t));
  EXCEPT_I32_ARRAY_EQ(i32_ans_m2, i32_buffer, 3 * 8,
                      " MFWCVT.XW.F.M  FP16   M1");
  // fp32 -> int64
  msettype(E32, M1, BA);
  msettilemi(4);
  msettileni(4);
  const fp32_t fp32_src[] = {-2.1946595, 5.254507,   3.9953413, -7.956445,
                             0.11064501, -5.1811824, 6.04432,   -2.6004004,
                             4.27166,    -4.4494247, 6.6714463, 4.334035,
                             -0.7287528, -1.0447924, 6.526566,  -5.2762847};
  const int64_t i64_ans_m2[] = {-2, 5,  4, -8, 0,  -5, 6, -3,
                                4,  -4, 7, 4,  -1, -1, 7, -5};
  mfloat32m1_t fp32_ts = mlce32_m1(fp32_src, 4 * sizeof(fp32_t));
  mint64m2_t i64_out_m2 = mfwcvt_xw_f_m(fp32_ts);
  msettype(E64, M2, BA);
  msettileni(4);
  msce64_m(i64_out_m2, i64_buffer, 4 * sizeof(int64_t));
  EXCEPT_I64_ARRAY_EQ(i64_ans_m2, i64_buffer, 4 * 4,
                      " MFWCVT.XW.F.M  FP32   M1");
  // M2
  // fp16 -> int32
  msettype(E16, M2, BA);
  msettilemi(3);
  msettileni(16);
  const fp16_t fp16_src_m2[] = {
      -0.8296, 3.633,  -5.805, -5.297, 0.7407, 6.52,   -9.984, 1.099,
      8.01,    8.234,  1.914,  -1.064, -7.684, 2.734,  -8.266, -2.494,
      -5.043,  -2.762, -1.415, -4.98,  5.99,   2.875,  -6.48,  -2.457,
      5.215,   -8.32,  -8.945, 4.145,  -2.703, -3.045, 4.57,   5.16,
      7.01,    -8.99,  -1.615, -2.074, 4.727,  -1.369, 9.73,   4.703,
      0.731,   8.18,   -3.414, 2.979,  -7.527, 0.7437, 1.627,  -0.2588};
  const int32_t i32_ans_m4[] = {-1, 4,  -6, -5, 1,  7,  -10, 1,  8,  8,  2,  -1,
                                -8, 3,  -8, -2, -5, -3, -1,  -5, 6,  3,  -6, -2,
                                5,  -8, -9, 4,  -3, -3, 5,   5,  7,  -9, -2, -2,
                                5,  -1, 10, 5,  1,  8,  -3,  3,  -8, 1,  2,  0};
  mfloat16m2_t fp16_ts_m2 = mlce16_m2(fp16_src_m2, 16 * sizeof(fp16_t));
  mint32m4_t i32_out_m4 = mfwcvt_xw_f_m(fp16_ts_m2);
  msettype(E32, M4, BA);
  msettileni(16);
  msce32_m(i32_out_m4, i32_buffer, 16 * sizeof(int32_t));
  EXCEPT_I32_ARRAY_EQ(i32_ans_m4, i32_buffer, 3 * 16,
                      "MFWCVT.XW.F.M  FP16   M2");
  // fp32 -> int64
  msettype(E32, M2, BA);
  msettilemi(4);
  msettileni(8);
  const fp32_t fp32_src_m2[] = {
      5.3358855, -8.60715,   5.4329653, -1.2881391, -3.5367346, -0.82014287,
      0.5825732, 7.200356,   3.0000072, 0.77485776, -4.9326386, -7.630354,
      2.764136,  4.8355823,  2.8542457, 3.9742527,  -4.56353,   0.8420419,
      3.693963,  -3.5525756, 0.8670662, -3.5855832, 0.59686565, -7.1642656,
      3.231219,  5.8822045,  -8.250844, -4.284634,  6.9076123,  -0.17289972,
      2.0510874, -5.2004747};
  const int64_t i64_ans_m4[] = {5,  -9, 5, -1, -4, -1, 1, 7, 3,  1, -5,
                                -8, 3,  5, 3,  4,  -5, 1, 4, -4, 1, -4,
                                1,  -7, 3, 6,  -8, -4, 7, 0, 2,  -5};
  mfloat32m2_t fp32_ts_m2 = mlce32_m2(fp32_src_m2, 8 * sizeof(fp32_t));
  mint64m4_t i64_out_m4 = mfwcvt_xw_f_m(fp32_ts_m2);
  msettype(E64, M4, BA);
  msettileni(8);
  msce64_m(i64_out_m4, i64_buffer, 8 * sizeof(int64_t));
  EXCEPT_I64_ARRAY_EQ(i64_ans_m4, i64_buffer, 4 * 8,
                      "MFWCVT.XW.F.M  FP32   M2");
}

static void test_mfncvt_x_fw_m() {
  // M2
  // fp16 -> int8
  msettype(E16, M2, BA);
  msettilemi(3);
  msettileni(16);
  const fp16_t fp16_src_m2[] = {
      -9.78,  7.92,   3.959,  4.21,  -1.337, -8.23,   -3.904, 1.052,
      5.777,  2.322,  -1.179, -9.2,  1.648,  3.754,   8.15,   -3.154,
      7.098,  -9.4,   9.02,   -9.19, 4.418,  -5.137,  0.256,  -8.58,
      1.671,  -3.414, -2.695, 8.42,  0.7324, -4.875,  -7.555, 9.375,
      0.1685, 4.234,  -4.426, -8.5,  6.914,  5.637,   -9.44,  -6.984,
      9.516,  -1.836, -1.373, 2.615, -1.343, -0.0439, 5.793,  -1.062};
  const int8_t i8_ans[] = {-10, 8,  4,  4,  -1, -8, -4, 1,  6,  2,  -1, -9,
                           2,   4,  8,  -3, 7,  -9, 9,  -9, 4,  -5, 0,  -9,
                           2,   -3, -3, 8,  1,  -5, -8, 9,  0,  4,  -4, -8,
                           7,   6,  -9, -7, 10, -2, -1, 3,  -1, 0,  6,  -1};
  mfloat16m2_t fp16_ts_m2 = mlce16_m2(fp16_src_m2, 16 * sizeof(fp16_t));
  mint8m1_t i8_out = mfncvt_x_fw_m(fp16_ts_m2);
  msettype(E8, M1, BA);
  msettileni(16);
  msce8_m(i8_out, i8_buffer, 16 * sizeof(int8_t));
  EXCEPT_I8_ARRAY_EQ(i8_ans, i8_buffer, 3 * 16, "MFNCVT.X.FW.M  FP16   M2");
  // fp32 -> int16
  msettype(E32, M2, BA);
  msettilemi(4);
  msettileni(8);
  const fp32_t fp32_src_m2[] = {
      -2.8336036, 2.0579631,  -8.14039,   9.228397,   -4.2479424, 5.5239806,
      -1.6912587, -9.81947,   3.9119823,  0.09915041, -8.4614315, 0.5548492,
      0.8021061,  -6.4676476, -6.9819126, -8.9862585, 7.0298705,  4.238449,
      8.972153,   -9.711984,  -8.613373,  -4.2217593, 0.25721633, -1.8228747,
      -5.786065,  -9.848495,  -7.595759,  -2.548692,  -4.769681,  -0.7174398,
      -4.953228,  -1.3903953};
  const int16_t i16_ans[] = {-3, 2,  -8, 9,   -4, 6,  -2, -10, 4,   0,  -8,
                             1,  1,  -6, -7,  -9, 7,  4,  9,   -10, -9, -4,
                             0,  -2, -6, -10, -8, -3, -5, -1,  -5,  -1};
  mfloat32m2_t fp32_ts_m2 = mlce32_m2(fp32_src_m2, 8 * sizeof(fp32_t));
  mint16m1_t i16_out = mfncvt_x_fw_m(fp32_ts_m2);
  msettype(E16, M1, BA);
  msettileni(8);
  msce16_m(i16_out, i16_buffer, 8 * sizeof(int16_t));
  EXCEPT_I16_ARRAY_EQ(i16_ans, i16_buffer, 4 * 8, "MFNCVT.X.FW.M  FP32   M2");
  // fp64 -> int32
  msettype(E64, M2, BA);
  msettilemi(5);
  msettileni(4);
  const fp64_t fp64_src_m2[] = {
      -9.58702834, 3.20320423,  5.15393443,  7.53595502,  2.78911799,
      9.45600847,  -4.04789086, -5.28737723, -4.18049511, -6.95942817,
      0.94875808,  -6.04677787, 0.59032454,  -8.49814603, -8.21399427,
      -9.59608063, 2.60284455,  7.57761812,  -5.40826356, -9.20956957};
  const int32_t i32_ans[] = {-10, 3,  5, 8,  3,  9,   -4, -5, -4, -7,
                             1,   -6, 1, -8, -8, -10, 3,  8,  -5, -9};
  mfloat64m2_t fp64_ts_m2 = mlce64_m2(fp64_src_m2, 4 * sizeof(fp64_t));
  mint32m1_t i32_out = mfncvt_x_fw_m(fp64_ts_m2);
  msettype(E32, M1, BA);
  msettileni(4);
  msce32_m(i32_out, i32_buffer, 4 * sizeof(int32_t));
  EXCEPT_I32_ARRAY_EQ(i32_ans, i32_buffer, 5 * 4, "MFNCVT.X.FW.M  FP64   M2");
  // M4
  // fp16 -> int8
  msettype(E16, M4, BA);
  msettilemi(3);
  msettileni(32);
  const fp16_t fp16_src_m4[] = {
      -0.5166, -8.56,  0.6733, -1.437, -3.87,   -6.69,  -1.193, -4.65,  -2.139,
      5.832,   -2.568, -5.5,   -4.55,  -5.18,   -6.88,  -0.509, 1.129,  7.902,
      0.97,    2.258,  8.78,   0.045,  -0.1326, 0.3345, -1.539, -7.242, -6.355,
      0.7827,  -7.12,  -4.383, 7.75,   -5.32,   6.406,  -9.82,  8.766,  8.,
      -8.28,   9.74,   -8.89,  -3.373, -6.016,  4.58,   -8.47,  -9.305, -9.016,
      -9.305,  7.2,    6.293,  -4.84,  -4.082,  6.953,  3.717,  -0.905, -7.28,
      -4.375,  5.363,  6.887,  3.275,  9.11,    -1.742, 3.64,   -9.68,  -0.657,
      3.18,    -3.668, 3.67,   7.715,  -2.848,  9.92,   -8.11,  -3.762, -5.707,
      -4.824,  3.426,  -7.883, 0.846,  -1.401,  3.33,   -8.,    1.196,  -5.2,
      2.56,    -7.26,  -5.746, -8.09,  -0.9946, 3.295,  -3.799, -1.858, 2.445,
      9.71,    4.816,  2.24,   -6.47,  2.572,   -0.61};
  const int8_t i8_ans_m2[] = {
      -1, -9,  1,  -1, -4, -7, -1, -5, -2, 6,  -3, -6, -5, -5,  -7, -1,
      1,  8,   1,  2,  9,  0,  0,  0,  -2, -7, -6, 1,  -7, -4,  8,  -5,
      6,  -10, 9,  8,  -8, 10, -9, -3, -6, 5,  -8, -9, -9, -9,  7,  6,
      -5, -4,  7,  4,  -1, -7, -4, 5,  7,  3,  9,  -2, 4,  -10, -1, 3,
      -4, 4,   8,  -3, 10, -8, -4, -6, -5, 3,  -8, 1,  -1, 3,   -8, 1,
      -5, 3,   -7, -6, -8, -1, 3,  -4, -2, 2,  10, 5,  2,  -6,  3,  -1};
  mfloat16m4_t fp16_ts_m4 = mlce16_m4(fp16_src_m4, 32 * sizeof(fp16_t));
  mint8m2_t i8_out_m2 = mfncvt_x_fw_m(fp16_ts_m4);
  msettype(E8, M2, BA);
  msettileni(32);
  msce8_m(i8_out_m2, i8_buffer, 32 * sizeof(int8_t));
  EXCEPT_I8_ARRAY_EQ(i8_ans_m2, i8_buffer, 3 * 32, "MFNCVT.X.FW.M  FP16   M4");
  // fp32 -> int16
  msettype(E32, M4, BA);
  msettilemi(4);
  msettileni(16);
  const fp32_t fp32_src_m4[] = {
      -8.240556,   -6.4473915, 4.365699,   0.07549725, -5.935011,   6.907019,
      2.4307115,   9.581047,   -4.5815535, 8.293949,   0.45241442,  -3.796592,
      2.113064,    -7.847424,  9.057057,   -4.310446,  -3.9771512,  -8.809971,
      7.4744773,   -1.9690545, 5.0447183,  4.7994366,  5.231901,    -6.4672775,
      -0.67091376, -3.8322258, 1.8657311,  -5.0674295, 8.550273,    0.12866186,
      -3.0858722,  9.334211,   0.4985755,  -8.162887,  1.3358032,   0.30090547,
      -4.013034,   -4.0899158, -4.619549,  -1.3142928, 2.4403868,   3.941254,
      -6.8678904,  9.455991,   6.1126294,  -4.2443886, 6.830589,    -4.0960426,
      -9.933542,   -4.2670255, -5.546113,  5.3344917,  -0.38296568, 5.40923,
      5.2476277,   2.5719876,  -1.1288443, -1.4248269, -5.5216603,  -9.167455,
      0.97469413,  5.646587,   -4.8886304, 2.4453695};
  const int16_t i16_ans_m2[] = {
      -8,  -6, 4,  0,  -6, 7,  2,  10, -5, 8,  0,  -4, 2, -8, 9,  -4,
      -4,  -9, 7,  -2, 5,  5,  5,  -6, -1, -4, 2,  -5, 9, 0,  -3, 9,
      0,   -8, 1,  0,  -4, -4, -5, -1, 2,  4,  -7, 9,  6, -4, 7,  -4,
      -10, -4, -6, 5,  0,  5,  5,  3,  -1, -1, -6, -9, 1, 6,  -5, 2};
  mfloat32m4_t fp32_ts_m4 = mlce32_m4(fp32_src_m4, 16 * sizeof(fp32_t));
  mint16m2_t i16_out_m2 = mfncvt_x_fw_m(fp32_ts_m4);
  msettype(E16, M2, BA);
  msettileni(16);
  msce16_m(i16_out_m2, i16_buffer, 16 * sizeof(int16_t));
  EXCEPT_I16_ARRAY_EQ(i16_ans_m2, i16_buffer, 4 * 16,
                      "MFNCVT.X.FW.M  FP32   M4");
  // fp64 -> int32
  msettype(E64, M4, BA);
  msettilemi(5);
  msettileni(8);
  const fp64_t fp64_src_m4[] = {
      2.2101213,   2.48257721, 4.15859772,  -6.00795214, 0.90577168,
      -6.0911692,  6.91772275, -8.28725282, 6.74698109,  5.17358197,
      -9.42978303, 7.61665169, 4.97636444,  2.89309345,  -7.28133784,
      -3.65177395, 9.05713819, 0.69530918,  -9.08594343, 1.21081692,
      1.32028854,  4.62412015, 0.96459729,  5.34485359,  -4.12064306,
      -4.82351437, 2.60767805, -5.91796871, -1.2591062,  -2.16634001,
      -7.92930675, -8.2176186, 1.88244821,  9.6995332,   2.21071975,
      -7.13299565, 6.18258553, 5.54100121,  3.94900951,  -7.53294748};
  const int32_t i32_ans_m2[] = {
      2, 2, 4, -6, 1,  -6, 7, -8, 7,  5,  -9, 8,  5, 3,  -7, -4, 9, 1, -9, 1,
      1, 5, 1, 5,  -4, -5, 3, -6, -1, -2, -8, -8, 2, 10, 2,  -7, 6, 6, 4,  -8};
  mfloat64m4_t fp64_ts_m4 = mlce64_m4(fp64_src_m4, 8 * sizeof(fp64_t));
  mint32m2_t i32_out_m2 = mfncvt_x_fw_m(fp64_ts_m4);
  msettype(E32, M2, BA);
  msettileni(8);
  msce32_m(i32_out_m2, i32_buffer, 8 * sizeof(int32_t));
  EXCEPT_I32_ARRAY_EQ(i32_ans_m2, i32_buffer, 5 * 8,
                      "MFNCVT.X.FW.M  FP64   M4");
}

static void test_mfcvt_xw_fw_m() {
  // M2
  // fp32 -> int32
  msettype(E32, M2, BA);
  msettilemi(4);
  msettileni(8);
  const fp32_t fp32_src_m2[] = {
      -76.37057,  -43.498177, 25.357216,  -93.96739,  33.503437, -66.059875,
      -46.469933, 19.840685,  -83.62408,  -75.26368,  17.08524,  -55.6274,
      9.493131,   -9.364949,  77.854164,  39.32595,   78.55958,  82.84494,
      39.71408,   -5.5968122, -16.427088, -30.351309, 55.245995, 64.6514,
      89.02269,   -56.244423, -43.522823, 84.58838,   30.242256, 95.594,
      97.00471,   77.08212};
  const int32_t i32_ans_m2[] = {
      -76, -43, 25, -94, 34,  -66, -46, 20, -84, -75, 17,  -56, 9,  -9, 78, 39,
      79,  83,  40, -6,  -16, -30, 55,  65, 89,  -56, -44, 85,  30, 96, 97, 77};
  mfloat32m2_t fp32_ts_m2 = mlce32_m2(fp32_src_m2, 8 * sizeof(fp32_t));
  mint32m2_t i32_out_m2 = mfcvt_xw_fw_m(fp32_ts_m2);
  msce32_m(i32_out_m2, i32_buffer, 8 * sizeof(int32_t));
  EXCEPT_I32_ARRAY_EQ(i32_ans_m2, i32_buffer, 4 * 8,
                      "MFCVT.XW.FW.M  FP32   M2");
  // fp64 -> int64
  msettype(E64, M2, BA);
  msettilemi(5);
  msettileni(4);
  const fp64_t fp64_src_m2[] = {
      -8.73843573, 83.10096405,  96.32553302,  89.54438001,  -28.20885592,
      11.58998323, -24.47558195, -44.3289969,  -89.94233535, -90.04804829,
      79.09503452, -46.33082944, 35.05151331,  -91.46000314, -10.5590488,
      51.45854833, -86.08492762, -21.11980722, 58.444159,    62.51857006};
  const int64_t i64_ans_m2[] = {-9, 83,  96, 90,  -28, 12, -24, -44, -90, -90,
                                79, -46, 35, -91, -11, 51, -86, -21, 58,  63};
  mfloat64m2_t fp64_ts_m2 = mlce64_m2(fp64_src_m2, 4 * sizeof(fp64_t));
  mint64m2_t i64_out_m2 = mfcvt_xw_fw_m(fp64_ts_m2);
  msce64_m(i64_out_m2, i64_buffer, 4 * sizeof(int64_t));
  EXCEPT_I64_ARRAY_EQ(i64_ans_m2, i64_buffer, 5 * 4,
                      "MFCVT.XW.FW.M  FP64   M2");
  // M4
  // fp32 -> int32
  msettype(E32, M4, BA);
  msettilemi(4);
  msettileni(16);
  const fp32_t fp32_src_m4[] = {
      70.90998,   -53.06203,  87.729805,  7.0674777,  -12.416589, -78.83471,
      -25.497782, -56.718395, 10.745131,  4.361095,   6.9410386,  -4.5544896,
      -80.73045,  -11.898623, 11.017656,  13.661969,  56.37002,   2.4799595,
      -95.869385, -0.8918992, -71.01021,  -45.17623,  4.2891183,  82.84955,
      -24.651123, 73.78811,   -68.12334,  13.216395,  -40.744427, 22.887857,
      27.425547,  4.2972064,  -13.465093, -92.077644, 36.817425,  -13.572885,
      78.83627,   -64.69757,  20.651403,  10.136692,  -17.816034, -95.41644,
      -7.967476,  -3.2543402, -32.149033, 83.875694,  69.86758,   -35.04689,
      -42.00485,  18.531488,  29.129166,  -29.162296, -62.70933,  -9.649649,
      19.49848,   89.42352,   -81.44638,  -95.59652,  -81.28432,  45.166653,
      75.370285,  -42.96992,  26.452421,  68.04882};
  const int32_t i32_ans_m4[] = {
      71,  -53, 88,  7,  -12, -79, -25, -57, 11,  4,   7,  -5,  -81,
      -12, 11,  14,  56, 2,   -96, -1,  -71, -45, 4,   83, -25, 74,
      -68, 13,  -41, 23, 27,  4,   -13, -92, 37,  -14, 79, -65, 21,
      10,  -18, -95, -8, -3,  -32, 84,  70,  -35, -42, 19, 29,  -29,
      -63, -10, 19,  89, -81, -96, -81, 45,  75,  -43, 26, 68};
  mfloat32m4_t fp32_ts_m4 = mlce32_m4(fp32_src_m4, 16 * sizeof(fp32_t));
  mint32m4_t i32_out_m4 = mfcvt_xw_fw_m(fp32_ts_m4);
  msce32_m(i32_out_m4, i32_buffer, 16 * sizeof(int32_t));
  EXCEPT_I32_ARRAY_EQ(i32_ans_m4, i32_buffer, 4 * 16,
                      "MFCVT.XW.FW.M  FP32   M4");
  // fp64 -> int64
  msettype(E64, M4, BA);
  msettilemi(5);
  msettileni(8);
  const fp64_t fp64_src_m4[] = {
      99.56286534,  -55.88564762, -54.40044998, -46.9724685,  60.08981998,
      94.05326312,  -31.97392666, -60.39859539, -91.36766439, -84.47954315,
      -21.97310639, 4.15617049,   -2.34655033,  -51.32406497, -18.50535213,
      -9.15390633,  47.74615639,  78.87617563,  49.88787529,  77.50381761,
      -17.38702927, 43.74780246,  32.03208993,  -57.78959722, 39.81497277,
      -62.8065617,  -84.55742029, 88.85554783,  61.19003629,  71.38797709,
      -10.49714096, -95.88386887, -21.26212269, -93.81983005, 32.79132025,
      -14.61584962, -44.85344117, 81.01307882,  73.21143388,  99.85857945};
  const int64_t i64_ans_m4[] = {
      100, -56, -54, -47, 60,  94,  -32, -60, -91, -84, -22, 4,   -2,  -51,
      -19, -9,  48,  79,  50,  78,  -17, 44,  32,  -58, 40,  -63, -85, 89,
      61,  71,  -10, -96, -21, -94, 33,  -15, -45, 81,  73,  100};
  mfloat64m4_t fp64_ts_m4 = mlce64_m4(fp64_src_m4, 8 * sizeof(fp64_t));
  mint64m4_t i64_out_m4 = mfcvt_xw_fw_m(fp64_ts_m4);
  msce64_m(i64_out_m4, i64_buffer, 8 * sizeof(int64_t));
  EXCEPT_I64_ARRAY_EQ(i64_ans_m4, i64_buffer, 5 * 8,
                      "MFCVT.XW.FW.M  FP64   M4");
}

static void test_mfwcvt_xq_fw_m() {
  msettype(E32, M2, BA);
  msettilemi(4);
  msettileni(8);
  const fp32_t fp32_src_m2[] = {
      29.06735433,  -41.04399618, -29.37416174, 59.56977474,  5.78607925,
      -9.04083416,  -34.6046038,  -4.23213078,  -15.5190629,  -19.51695419,
      -18.16896526, -24.16176363, 21.49347017,  62.04863099,  74.04649366,
      92.88309396,  -94.92514784, -3.17739831,  -20.96330581, 14.16560605,
      -48.09206054, -44.71671939, -7.09213429,  -4.88791034,  1.73413581,
      31.70018278,  19.9981799,   -56.43096518, -32.81767891, -70.9858084,
      -67.49389757, -60.26767522};
  const int64_t i64_ans_m4[] = {29,  -41, -29, 60,  6,   -9,  -35, -4,
                                -16, -20, -18, -24, 21,  62,  74,  93,
                                -95, -3,  -21, 14,  -48, -45, -7,  -5,
                                2,   32,  20,  -56, -33, -71, -67, -60};
  mfloat32m2_t fp32_ts_m2 = mlce32_m2(fp32_src_m2, 8 * sizeof(fp32_t));
  mint64m4_t i64_out_m4 = mfwcvt_xq_fw_m(fp32_ts_m2);
  msettype(E64, M4, BA);
  msettileni(8);
  msce64_m(i64_out_m4, i64_buffer, 8 * sizeof(int64_t));
  EXCEPT_I64_ARRAY_EQ(i64_ans_m4, i64_buffer, 4 * 8,
                      "MFWCVT.XQ.FW.M FP32   M2");
}

static void test_mfwcvt_xq_f_m() {
  msettype(E16, M1, BA);
  msettilemi(2);
  msettileni(8);
  const fp16_t fp16_src_m1[] = {
      45366.50771149,  52406.56717189, -56307.32443555, 40180.48694464,
      -31788.75583393, 4584.11526289,  10583.6153262,   -41071.29526986,
      -50848.72234078, 12425.82623496, -56213.63629754, -12730.56378413,
      -49779.99219342, 47999.66638771, -30887.97873791, -61005.08208527};
  const int64_t i64_ans_m4[] = {45367,  52407,  -56307, 40180, -31789, 4584,
                                10584,  -41071, -50849, 12426, -56214, -12731,
                                -49780, 48000,  -30888, -61005};
  mfloat16m1_t fp16_ts_m1 = mlce16_m1(fp16_src_m1, 8 * sizeof(fp16_t));
  mint64m4_t i64_out_m4 = mfwcvt_xq_f_m(fp16_ts_m1);
  msettype(E64, M4, BA);
  msettilemi(2);
  msettileni(8);
  msce64_m(i64_out_m4, i64_buffer, 8 * sizeof(int64_t));
  EXCEPT_I64_ARRAY_EQ(i64_ans_m4, i64_buffer, 0, "MFWCVT.XQ.F.M  FP16   M1");
}

static void test_mfncvt_fw_xq_m() {
//   msettype(E32, M4, BA);
//   msettilemi(4);
//   msettileni(16);
//   const int32_t i32_src_m4[] = {
//       835,  -267, -623, 544,  552,  -799, 101,  947,  830,  -112, 213,
//       224,  781,  193,  112,  888,  974,  -819, 433,  912,  -983, 31,
//       195,  -730, 868,  -31,  -385, 299,  111,  -313, -779, 357,  -370,
//       229,  379,  -925, 349,  811,  -842, -918, -103, 617,  442,  834,
//       -39,  -596, 19,   -511, 727,  -553, 796,  815,  320,  -401, -396,
//       -233, 268,  -282, -917, -176, -881, 378,  503,  497};
//   const fp16_t fp16_ans_m2[] = {
//       835.,  -267., -623., 544.,  552.,  -799., 101.,  947.,  830.,  -112.,
//       213.,  224.,  781.,  193.,  112.,  888.,  974.,  -819., 433.,  912.,
//       -983., 31.,   195.,  -730., 868.,  -31.,  -385., 299.,  111.,  -313.,
//       -779., 357.,  -370., 229.,  379.,  -925., 349.,  811.,  -842., -918.,
//       -103., 617.,  442.,  834.,  -39.,  -596., 19.,   -511., 727.,  -553.,
//       796.,  815.,  320.,  -401., -396., -233., 268.,  -282., -917., -176.,
//       -881., 378.,  503.,  497.};
//   mint32m4_t i32_ts_m4 = mlce32_m4(i32_src_m4, 16 * sizeof(int32_t));
//   mfloat16m2_t fp16_out_m2 = mfncvt_fw_xq_m(i32_ts_m4);
//   msettype(E16, M2, BA);
//   msettileni(16);
//   msce16_m(fp16_out_m2, fp16_buffer, 16 * sizeof(fp16_t));
//   EXCEPT_FP16_ARRAY_LAX_EQ(fp16_ans_m2, fp16_buffer, 4 * 16,
//                            "MFNCVT.FW.XQ.M INT32  M4");

  msettype(E64, M4, BA);
  msettilemi(5);
  msettileni(8);
  const int64_t i64_src_m4[] = {
      9438,  -7029, -8745, -6112, 2107,  -1516, -9526, 9488,  612,   4398,
      -8424, 9167,  -2660, 1184,  -6680, 6988,  5710,  -7775, 666,   -3770,
      -8334, -4885, 7889,  -3855, 8662,  5067,  2999,  -21,   -2209, 6950,
      9230,  -9903, -3171, -8185, 7482,  -848,  -4638, 224,   -7351, 3263};
  const fp32_t fp32_ans_m2[] = {
      9438.,  -7029., -8745., -6112., 2107.,  -1516., -9526., 9488.,
      612.,   4398.,  -8424., 9167.,  -2660., 1184.,  -6680., 6988.,
      5710.,  -7775., 666.,   -3770., -8334., -4885., 7889.,  -3855.,
      8662.,  5067.,  2999.,  -21.,   -2209., 6950.,  9230.,  -9903.,
      -3171., -8185., 7482.,  -848.,  -4638., 224.,   -7351., 3263.};
  mint64m4_t i64_ts_m4 = mlce64_m4(i64_src_m4, 8 * sizeof(int64_t));
  mfloat32m2_t fp32_out_m2 = mfncvt_fw_xq_m(i64_ts_m4);
  msettype(E32, M2, BA);
  msettileni(8);
  msce32_m(fp32_out_m2, fp32_buffer, 8 * sizeof(fp32_t));
  EXCEPT_FP32_ARRAY_LAX_EQ(fp32_ans_m2, fp32_buffer, 5 * 8,
                           "MFNCVT.FW.XQ.M INT64  M4");
}

int main() {
  test_mfncvt_fw_f_m();
  test_mfncvt_f_fw_m();
  test_mfcvt_x_f_m();
  test_mfncvt_f_xw_m();
  test_mfncvt_f_xq_m();
  test_mfcvt_f_x_m();
  test_mfwcvt_fw_x_m();
  test_mfcvt_fw_xw_m();
  test_mfwcvt_xw_f_m();
  test_mfncvt_x_fw_m();
  test_mfcvt_xw_fw_m();
  test_mfwcvt_xq_fw_m();
  test_mfwcvt_xq_f_m();
  test_mfncvt_fw_xq_m();
  return 0;
}